<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.82.1" />

<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/android-chrome-512x512.png" sizes="512x512">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/site.webmanifest">
<title>Building gRPC services with bazel and rules_protobuf | gRPC</title>
<meta property="og:title" content="Building gRPC services with bazel and rules_protobuf" />
<meta property="og:description" content="gRPC makes it easier to build high-performance
microservices by providing generated service entrypoints in a variety
of different languages.  Bazel complements these
efforts with a capable and fast polyglot build environment.
rules_protobuf extends
bazel and makes it easier develop gRPC services." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Joevaen.github.io/blog/bazel-rules-protobuf/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2016-10-13T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-12-16T23:13:50-08:00" /><meta property="og:site_name" content="gRPC" />

<meta itemprop="name" content="Building gRPC services with bazel and rules_protobuf">
<meta itemprop="description" content="gRPC makes it easier to build high-performance
microservices by providing generated service entrypoints in a variety
of different languages.  Bazel complements these
efforts with a capable and fast polyglot build environment.
rules_protobuf extends
bazel and makes it easier develop gRPC services."><meta itemprop="datePublished" content="2016-10-13T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-12-16T23:13:50-08:00" />
<meta itemprop="wordCount" content="4439">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building gRPC services with bazel and rules_protobuf"/>
<meta name="twitter:description" content="gRPC makes it easier to build high-performance
microservices by providing generated service entrypoints in a variety
of different languages.  Bazel complements these
efforts with a capable and fast polyglot build environment.
rules_protobuf extends
bazel and makes it easier develop gRPC services."/>



<link rel="preload" href="/css/style.min.e3cf82e558200e98b09736f835e12b188dca1353aad6649d3429c72923031431.css" as="style">
<link href="/css/style.min.e3cf82e558200e98b09736f835e12b188dca1353aad6649d3429c72923031431.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-163836834-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-163836834-2');
  gtag('config', 'UA-60127042-1');
</script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="canonical" href="https://Joevaen.github.io/blog/bazel-rules-protobuf/">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@grpcio">
<meta name="twitter:creator" content="@grpcio">
<meta name="twitter:image" content="https://Joevaen.github.io/img/logos/grpc-icon-color.png">
<meta name="twitter:image:alt" content="gRPC color logo">

<meta property="og:url" content="https://Joevaen.github.io/blog/bazel-rules-protobuf/">
<meta property="og:title" content="Building gRPC services with bazel and rules_protobuf">
<meta property="og:description" content="A high-performance, open source universal RPC framework">
<meta property="og:type" content="article">
<meta property="og:site_name" content="gRPC">
<meta property="og:image" content="https://Joevaen.github.io/img/logos/grpc-icon-color.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:alt" content="gRPC color logo">
<meta property="og:locale" content="en_US">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/android-chrome-512x512.png" sizes="512x512">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/site.webmanifest">

  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="672pt" height="436pt" viewBox="0 0 672 436"><g transform="translate(0.000000,436.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M3066 3659c-376-41-707-264-894-602-35-63-50-101-45-113 4-12 3-15-5-10s-10 1-5-10c5-13 9-11 23 15 9 18 19 29 22 25 4-3 4 3 1 15-4 14-1 21 9 21 8 0 27 23 42 51 119 218 360 416 607 499 96 33 250 60 337 60 551 0 1009-390 1097-933 48-296-20-597-193-847-24-36-35-56-23-46 35 32 24 2-23-61-49-64-119-128-220-198-36-26-66-49-66-51 0-10 123 74 187 128 63 53 173 174 182 201 2 7 9 19 16 27s36 58 63 110c198 373 185 786-35 1159-25 42-60 95-79 118-42 51-45 68-4 22 68-76 190-285 190-326 0-7 5-12 11-10 6 1 14-4 17-12 2-8 0-11-5-8-6 4-8-4-5-19 3-18 7-22 12-13 6 8 12-2 19-29 6-23 15-59 21-80 31-121 29-332-5-516-9-44-13-81-11-83s16 47 31 109c26 106 27 122 22 268-4 119-12 179-32 260-56 225-191 440-375 598-70 59-261 182-284 182-6 0 25-21 69-47 44-25 105-65 135-89 62-48 149-134 135-134-6 0-32 23-60 51-67 67-224 171-325 215-78 34-249 83-294 85-21 0-21 1-1 9 15 7 8 9-30 10-27 0-72 2-1e2 4-27 2-86 0-129-5z"/><path d="M36e2 3580c8-5 20-10 25-10 6 0 3 5-5 10s-19 10-25 10c-5 0-3-5 5-10z"/><path d="M3519 3276c-69-18-136-62-211-138-191-194-325-488-288-630 12-45 45-88 67-88 18 0 16 19-2 27-24 9-45 57-45 103 0 121 141 397 271 531 111 115 241 189 303 173 1e2-25 76-265-64-626l-40-105-58-13c-79-17-211-65-309-110-197-92-359-233-429-375-35-71-39-87-39-154 0-65 4-83 28-123 61-104 188-133 299-70 70 41 176 152 251 265 67 102 188 333 243 464 37 89 39 92 79 102 43 11 84 36 74 45-3 3-24-2-47-11s-45-14-48-11 15 63 41 133c126 349 145 579 49 615-33 13-68 12-125-4zm-29-794c0-4-47-102-104-218-197-398-362-594-5e2-594-68 0-124 44-151 119-85 243 203 545 645 675 93 27 110 30 110 18z"/><path d="M2081 2794c0-11 3-14 6-6 3 7 2 16-1 19-3 4-6-2-5-13z"/><path d="M4291 2784c0-11 3-14 6-6 3 7 2 16-1 19-3 4-6-2-5-13z"/><path d="M2071 2754c0-11 3-14 6-6 3 7 2 16-1 19-3 4-6-2-5-13z"/><path d="M4302 2740c0-14 2-19 5-12 2 6 2 18 0 25-3 6-5 1-5-13z"/><path d="M2061 2714c0-11 3-14 6-6 3 7 2 16-1 19-3 4-6-2-5-13z"/><path d="M2052 2660c0-14 2-19 5-12 2 6 2 18 0 25-3 6-5 1-5-13z"/><path d="M2043 2585c0-22 2-30 4-17 2 12 2 30 0 40-3 9-5-1-4-23z"/><path d="M4252 2018c-15-37-19-55-11-63 7-7 8-4 3 9-6 15-4 17 6 11 9-5 11-4 6 3-4 7-3 12 3 12s7 7 4 17c-5 12-3 14 8 8 8-4 11-5 7 0-4 4-4 13 2 19 5 7 5 17 1 24s-15-8-29-40z"/><path d="M4205 1919c-3-4 2-6 10-5 21 3 28 13 10 13-9 0-18-4-20-8z"/><path d="M4024 1668l-19-23 23 19c12 11 22 21 22 23 0 8-8 2-26-19z"/><path d="M4015 1628l-40-43 43 40c39 36 47 45 39 45-2 0-21-19-42-42z"/><path d="M3969 1613c-13-16-12-17 4-4s21 21 13 21c-2 0-10-8-17-17z"/><path d="M3919 1543c-13-16-12-17 4-4 9 7 17 15 17 17 0 8-8 3-21-13z"/><path d="M3705 1428c-11-6-23-15-26-20-3-6-9-9-13-9-19 3-27 0-22-7 7-12-61-35-75-26-8 5-9 3-4-6 6-10 3-12-13-8-14 4-20 2-15-5 4-6-2-8-15-5-12 4-20 2-17-2 3-5 0-10-7-13-7-2-2-2 12 0 39 7 179 63 194 78 7 8 16 12 18 10 3-3 5 2 5 10s-1 15-1 15c-1 0-10-6-21-12z"/><path d="M3448 1313c7-3 16-2 19 1 4 3-2 6-13 5-11 0-14-3-6-6z"/><path d="M3355 13e2c-27-7-27-8-5-8 14 0 39 4 55 8 27 7 27 8 5 8-14 0-38-4-55-8z"/><path d="M3263 1283c9-2 25-2 35 0 9 3 1 5-18 5s-27-2-17-5z"/><path d="M1810 981c0-75-4-103-15-115-17-17-20-66-4-66 6 0 24 13 40 29 29 29 29 31 29 140v111h-25c-25 0-25 0-25-99z"/><path d="M2211 1062c-51-25-73-61-74-120-1-70 33-116 101-137 36-10 28 31-13 69-26 25-35 42-35 66s9 41 35 66c19 18 35 42 35 53 0 25-5 26-49 3z"/><path d="M2290 1060c0-12 16-36 35-54 26-25 35-42 35-66s-9-41-35-66c-41-38-49-79-12-69 66 20 99 65 99 135s-33 115-99 135c-19 5-23 2-23-15z"/><path d="M2692 1053l3-28h1e2 1e2l3 28 3 27h-106-106l3-27z"/><path d="M3150 1068c0-7 23-70 52-140 48-119 53-128 78-128s30 9 78 130c29 72 52 135 52 141s-12 9-27 7c-23-2-31-13-51-63-13-33-31-76-39-95l-14-35-25 59c-13 33-24 63-24 67s15 9 33 11c27 2 32 7 32 28 0 24-3 25-72 28-55 2-73 0-73-10z"/><path d="M3724 1003c-43-93-48-128-19-128 15 0 28 17 50 63l30 62 25-62c14-35 27-66 28-70 2-5-35-8-82-8-76 0-86-2-1e2-22-8-12-13-25-10-30 7-11 261-10 268 1 3 5-19 67-49 137-48 114-57 129-80 132s-29-4-61-75z"/><path d="M4187 1073c-4-3-7-14-7-24 0-25 28-31 125-27 79 3 80 3 83 31l3 27h-99c-54 0-102-3-105-7z"/><path d="M4670 1068c0-7 43-71 96-141 77-105 99-128 117-125 21 3 22 7 25 141l3 138-28-3c-28-3-28-4-33-86l-5-83-62 85c-50 69-68 86-88 86-14 0-25-6-25-12z"/><path d="M2694 955c-14-37 2-45 89-45 88 0 114 11 101 44-9 23-182 24-190 1z"/><path d="M4184 955c-3-8-3-22 0-30 5-13 22-15 98-13 92 3 93 3 93 28s-1 25-93 28c-76 2-93 0-98-13z"/><path d="M1675 890c-10-16 4-48 32-70 32-25 40-25 48 0 13 40-60 103-80 70z"/><path d="M4670 850c0-47 2-50 25-50s25 3 25 50-2 50-25 50-25-3-25-50z"/><path d="M2694 845c-3-8-3-22 0-30 5-13 23-15 103-13 97 3 98 3 98 28s-1 25-98 28c-80 2-98 0-103-13z"/><path d="M4184 845c-15-38 1-45 106-45h101l-3 28-3 27-98 3c-80 2-98 0-103-13z"/></g></svg></span><span class="text-uppercase font-weight-bold">gRPC</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs/" ><span>Docs</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/showcase/" ><span>Showcase</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>Blog</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/community/" ><span>Community</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    
<input type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/blog/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">
      
        gRPC Blog
      
    </a>
  </li>
  <ul>
    <li class="collapse show" id="blog">
      
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-csharp-future" href="/blog/grpc-csharp-future/">
            
              The future of gRPC in C# belongs to grpc-dotnet
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogwireshark" href="/blog/wireshark/">
            
              Analyzing gRPC messages using Wireshark
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-web-interceptor" href="/blog/grpc-web-interceptor/">
            
              Interceptors in gRPC-Web
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-js-10" href="/blog/grpc-js-1.0/">
            
              Announcing gRPC-JS 1.0
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogkotlin-meet-grpc" href="/blog/kotlin-meet-grpc/">
            
              Kotlin, meet gRPC
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-cloud-run" href="/blog/grpc-cloud-run/">
            
              gRPC comes to Cloud Run
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogcmake-improvements" href="/blog/cmake-improvements/">
            
              Improvements to gRPC&#39;s CMake Build System
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-on-dotnetcore" href="/blog/grpc-on-dotnetcore/">
            
              .NET Core ❤ gRPC
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloghello-pancakes" href="/blog/hello-pancakes/">
            
              Dear gRPC
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogstate-of-grpc-web" href="/blog/state-of-grpc-web/">
            
              The state of gRPC in the browser
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-stacks" href="/blog/grpc-stacks/">
            
              Visualizing gRPC Language Stacks
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-web-ga" href="/blog/grpc-web-ga/">
            
              gRPC-Web is Generally Available
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloga-short-introduction-to-channelz" href="/blog/a-short-introduction-to-channelz/">
            
              A short introduction to Channelz
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-on-http2" href="/blog/grpc-on-http2/">
            
              gRPC on HTTP/2 Engineering a Robust, High-performance Protocol
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-with-json" href="/blog/grpc-with-json/">
            
              gRPC &#43; JSON
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogtake-the-grpc-survey" href="/blog/take-the-grpc-survey/">
            
              Take the gRPC Survey!
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggraceful-cleanup-junit-tests" href="/blog/graceful-cleanup-junit-tests/">
            
              Gracefully clean up in gRPC JUnit tests
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-dotnet-build" href="/blog/grpc-dotnet-build/">
            
              gRPC Meets .NET SDK And Visual Studio: Automatic Codegen On Build
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogkotlin-gradle-projects" href="/blog/kotlin-gradle-projects/">
            
              gRPC ❤ Kotlin
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogoptimizing-grpc-part-2" href="/blog/optimizing-grpc-part-2/">
            
              So You Want to Optimize gRPC - Part 2
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogoptimizing-grpc-part-1" href="/blog/optimizing-grpc-part-1/">
            
              So You Want to Optimize gRPC - Part 1
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogdeadlines" href="/blog/deadlines/">
            
              gRPC and Deadlines
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-go-engineering-practices" href="/blog/grpc-go-engineering-practices/">
            
              gRPC-Go Engineering Practices
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogmeetup-kit" href="/blog/meetup-kit/">
            
              The gRPC Meetup Kit
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-go-perf-improvements" href="/blog/grpc-go-perf-improvements/">
            
              gRPC-Go performance Improvements
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogcommunity-meeting-update" href="/blog/community-meeting-update/">
            
              2017-08-17 Community Meeting Update
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-flatbuffers" href="/blog/grpc-flatbuffers/">
            
              Announcing out-of-the-box support for gRPC in the Flatbuffers serialization library
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-load-balancing" href="/blog/grpc-load-balancing/">
            
              gRPC Load Balancing
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloghelm-grpc" href="/blog/helm-grpc/">
            
              gRPC in Helm
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogyikyak" href="/blog/yikyak/">
            
              Migration to Google Cloud Platform — gRPC &amp; grpc-gateway
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page  active" id="m-blogbazel-rules-protobuf" href="/blog/bazel-rules-protobuf/">
            
              Building gRPC services with bazel and rules_protobuf
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogvsco" href="/blog/vsco/">
            
              gRPC at VSCO
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogvendasta" href="/blog/vendasta/">
            
              Why we have decided to move our APIs to gRPC
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogga-announcement" href="/blog/ga-announcement/">
            
              gRPC Project is now 1.0 and ready for production deployments
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogmobile-benchmarks" href="/blog/mobile-benchmarks/">
            
              Mobile Benchmarks
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogcoreos" href="/blog/coreos/">
            
              gRPC with REST and Open APIs
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloginstallation" href="/blog/installation/">
            
              gRPC - now with easy installation
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogpubsub" href="/blog/pubsub/">
            
              Google Cloud PubSub - with the power of gRPC!
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogbeta-release" href="/blog/beta-release/">
            
              gRPC releases Beta, opening door for use in production environments
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogprinciples" href="/blog/principles/">
            
              gRPC Motivation and Design Principles
            
            </a>
        
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
    
    
      
    
    
    
    
    
    
    

    <a href="https://github.com/grpc/grpc.io/edit/main/content/en/blog/bazel-rules-protobuf.md" target="_blank"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
    <a href="https://github.com/grpc/grpc.io/new/main/content/en/blog/bazel-rules-protobuf.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" target="_blank"><i class="fa fa-edit fa-fw"></i> Create child page</a>
    <a href="https://github.com/grpc/grpc.io/issues/new?title=Building%20gRPC%20services%20with%20bazel%20and%20rules_protobuf" target="_blank"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
    
      
      <a href="https://github.com/grpc/grpc.io/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
    

  
  
  </div>





<nav id="TableOfContents">
  <ul>
    <li><a href="#11-package-structure">1.1: Package Structure</a></li>
    <li><a href="#12-targets">1.2: Targets</a></li>
    <li><a href="#13-target-pattern-syntax">1.3: Target Pattern Syntax</a></li>
    <li><a href="#14-external-dependencies-workspace-rules">1.4: External Dependencies: Workspace Rules</a>
      <ul>
        <li><a href="#141-workspace-rules-that-require-a-pre-existing-workspace">1.4.1: Workspace Rules that require a pre-existing WORKSPACE</a></li>
        <li><a href="#142-workspace-rules-that-autogenerate-a-workspace-file-for-you">1.4.2: Workspace Rules that autogenerate a WORKSPACE file for you</a></li>
        <li><a href="#143-workspace-rules-that-accept-a-build-file-as-an-argument">1.4.3: Workspace Rules that accept a BUILD file as an argument</a></li>
      </ul>
    </li>
    <li><a href="#15-bazel-summary">1.5: Bazel Summary</a></li>
    <li><a href="#16-rules_protobuf">1.6: rules_protobuf</a></li>
  </ul>

  <ul>
    <li><a href="#21-services">2.1: Services</a></li>
    <li><a href="#22-compiled-programs">2.2: Compiled Programs</a></li>
    <li><a href="#23-protobuf-definitions">2.3: Protobuf Definitions</a></li>
    <li><a href="#24-build-the-grpc_greetertimer-example-application">2.4: Build the grpc_greetertimer example application.</a>
      <ul>
        <li><a href="#241-create-the-project-layout">2.4.1: Create the Project Layout</a></li>
        <li><a href="#242-the-workspace">2.4.2: The WORKSPACE</a></li>
        <li><a href="#243-the-greetertimer-server">2.4.3: The GreeterTimer Server</a></li>
        <li><a href="#244-the-greetertimer-client">2.4.4: The GreeterTimer Client</a></li>
        <li><a href="#245-generate-the-go-protobufgrpc-code">2.4.5: Generate the go protobuf+gRPC code</a></li>
        <li><a href="#246-generate-the-java-protobuf-libraries">2.4.6: Generate the java protobuf libraries</a></li>
        <li><a href="#247-run-it">2.4.7: Run it!</a></li>
      </ul>
    </li>
    <li><a href="#25-summary">2.5: Summary</a></li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            <a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href="https://Joevaen.github.io/blog/feed.xml" target="_blank">
              RSS <i class="fa fa-rss ml-2 "></i>
            </a>
            
<div class="td-content">
	<h1>Building gRPC services with bazel and rules_protobuf</h1>
	
	<div class="td-byline mb-4">
    By
			<a href="https://pubref.org"><b>Paul Cody Johnston</b></a>
			 (PubRef.org) |
			<time datetime="2016-10-13" class="text-muted">Thursday, October 13, 2016</time>
	</div>
	<div class="d-xl-none td-toc td-toc--inline d-print-none">
		
  
    
      <a id="td-content__toc-link" href="#td-content__toc" data-toggle="collapse" aria-controls="td-docs-toc" aria-expanded="false" aria-label="Toggle toc navigation">
        <span class="lead">Contents<i class="fas fa-chevron-right ml-2"></i></span>
      </a>
      <div id="td-content__toc" class="collapse">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#11-package-structure">1.1: Package Structure</a></li>
    <li><a href="#12-targets">1.2: Targets</a></li>
    <li><a href="#13-target-pattern-syntax">1.3: Target Pattern Syntax</a></li>
    <li><a href="#14-external-dependencies-workspace-rules">1.4: External Dependencies: Workspace Rules</a>
      <ul>
        <li><a href="#141-workspace-rules-that-require-a-pre-existing-workspace">1.4.1: Workspace Rules that require a pre-existing WORKSPACE</a></li>
        <li><a href="#142-workspace-rules-that-autogenerate-a-workspace-file-for-you">1.4.2: Workspace Rules that autogenerate a WORKSPACE file for you</a></li>
        <li><a href="#143-workspace-rules-that-accept-a-build-file-as-an-argument">1.4.3: Workspace Rules that accept a BUILD file as an argument</a></li>
      </ul>
    </li>
    <li><a href="#15-bazel-summary">1.5: Bazel Summary</a></li>
    <li><a href="#16-rules_protobuf">1.6: rules_protobuf</a></li>
  </ul>

  <ul>
    <li><a href="#21-services">2.1: Services</a></li>
    <li><a href="#22-compiled-programs">2.2: Compiled Programs</a></li>
    <li><a href="#23-protobuf-definitions">2.3: Protobuf Definitions</a></li>
    <li><a href="#24-build-the-grpc_greetertimer-example-application">2.4: Build the grpc_greetertimer example application.</a>
      <ul>
        <li><a href="#241-create-the-project-layout">2.4.1: Create the Project Layout</a></li>
        <li><a href="#242-the-workspace">2.4.2: The WORKSPACE</a></li>
        <li><a href="#243-the-greetertimer-server">2.4.3: The GreeterTimer Server</a></li>
        <li><a href="#244-the-greetertimer-client">2.4.4: The GreeterTimer Client</a></li>
        <li><a href="#245-generate-the-go-protobufgrpc-code">2.4.5: Generate the go protobuf+gRPC code</a></li>
        <li><a href="#246-generate-the-java-protobuf-libraries">2.4.6: Generate the java protobuf libraries</a></li>
        <li><a href="#247-run-it">2.4.7: Run it!</a></li>
      </ul>
    </li>
    <li><a href="#25-summary">2.5: Summary</a></li>
  </ul>
</nav>
      </div>
      <button id="td-content__toc-link-expanded" href="#td-content__toc" class="btn btn-small ml-1 my-2 py-0 px-3" data-toggle="collapse" aria-controls="td-docs-toc" aria-expanded="true" aria-label="Toggle toc navigation">
      </button>
    
  


	</div>
	
	<p><a href="/">gRPC</a> makes it easier to build high-performance
microservices by providing generated service entrypoints in a variety
of different languages.  <a href="https://bazel.io" target="_blank" rel="noopener">Bazel<i class="fas fa-external-link-alt"></i></a> complements these
efforts with a capable and fast polyglot build environment.</p>
<p><a href="https://github.com/pubref/rules_protobuf" target="_blank" rel="noopener">rules_protobuf<i class="fas fa-external-link-alt"></i></a> extends
bazel and makes it easier develop gRPC services.</p>
<p>It does this by:</p>
<ol>
<li>Building <code>protoc</code> (the protocol buffer compiler) and all the
necessary <code>protoc-gen-*</code> plugins.</li>
<li>Building the protobuf and gRPC libraries required for gRPC-related
code to compile.</li>
<li>Abstracting away <code>protoc</code> plugin invocation (you don&rsquo;t have to
necessarily learn or remember how to call <code>protoc</code>).</li>
<li>Regenerating and recompiling outputs when protobuf source files
change.</li>
</ol>
<p>In this post I&rsquo;ll provide background about how bazel works
(<a href="#about-bazel">Part 1</a>) and how to get started building gRPC
services with rules_protobuf
(<a href="#building">Part 2</a>).  If
you&rsquo;re already a bazel aficionado, you can skip directly to Part 2.</p>
<p>To best follow along,
<a href="https://www.bazel.io/versions/master/docs/install.html" target="_blank" rel="noopener">install bazel<i class="fas fa-external-link-alt"></i></a>
and clone the rules_protobuf repository:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~$ git clone https://github.com/pubref/rules_protobuf
~$ <span style="color:#366">cd</span> rules_protobuf
~/rules_protobuf$
</code></pre></div><p>Great. Let&rsquo;s get started!</p>
<h1 id="about-bazel">1: About Bazel</h1>
<p><a href="https://www.bazel.io/" target="_blank" rel="noopener">Bazel<i class="fas fa-external-link-alt"></i></a> is Google&rsquo;s open-source version of
their internal build tool called &ldquo;Blaze&rdquo;.  Blaze originated from the
challenges of managing a large monorepo with code written in a variety
of languages.  Blaze was the inspiration for other capable and fast
build tools including <a href="https://www.pantsbuild.org/" target="_blank" rel="noopener">Pants<i class="fas fa-external-link-alt"></i></a> and
<a href="https://buckbuild.com/" target="_blank" rel="noopener">Buck<i class="fas fa-external-link-alt"></i></a>.  Bazel is conceptually simple but
there are some core concepts &amp; terminology to understand:</p>
<ol>
<li>
<p><strong>Bazel command</strong>: a function that does some type of work when
called from the command line. Common ones include <code>bazel build</code>
(compile a libary), <code>bazel run</code> (run a binary executable), <code>bazel test</code> (execute tests), and <code>bazel query</code> (tell me something about
the build dependency graph).  See all with <code>bazel help</code>.</p>
</li>
<li>
<p><strong>Build phases</strong>: the three stages (loading, analysis, and
execution) that bazel goes through when calling a bazel command.</p>
</li>
<li>
<p><strong>The WORKSPACE file</strong>: a required file that defines the project
root.  It is primarily used to declare external dependencies
(external workspaces).</p>
</li>
<li>
<p><strong>BUILD files</strong>: the presence of a <code>BUILD</code> file in a directory
defines it as a <em>package</em>.  <code>BUILD</code> files contain <em>rules</em> that define
<em>targets</em> which can be selected using the <em>target pattern syntax</em>.
Rules are written in a python-like language called
<a href="https://bazel.io/versions/master/docs/skylark/index.html" target="_blank" rel="noopener"><em>skylark</em><i class="fas fa-external-link-alt"></i></a>.
Syklark has stronger deterministic guarantees than python but is
intentionally minimal, excluding language features such as recursion,
classes, and lambdas.</p>
</li>
</ol>
<h2 id="11-package-structure">1.1: Package Structure</h2>
<p>To illustrate these concepts, let&rsquo;s look at the package structure of
the
<a href="https://github.com/pubref/rules_protobuf/tree/master/examples" target="_blank" rel="noopener">rules_protobuf examples subdirectory<i class="fas fa-external-link-alt"></i></a>.
Let&rsquo;s look at the file tree, showing only those folder having a
<code>BUILD</code> file:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">$ tree -P &#39;BUILD|WORKSPACE&#39; -I &#39;third_party|bzl&#39; examples/
.
├── BUILD
├── WORKSPACE
└── examples
    ├── helloworld
    │   ├── cpp
    │   │   └── BUILD
    │   ├── go
    │   │   ├── client
    │   │   │   └── BUILD
    │   │   ├── greeter_test
    │   │   │   └── BUILD
    │   │   └── server
    │   │       └── BUILD
    │   ├── grpc_gateway
    │   │   └── BUILD
    │   ├── java
    │   │   └── org
    │   │       └── pubref
    │   │           └── rules_protobuf
    │   │               └── examples
    │   │                   └── helloworld
    │   │                       ├── client
    │   │                       │   └── BUILD
    │   │                       └── server
    │   │                           └── BUILD
    │   └── proto
    │       └── BUILD
    └── proto
        └── BUILD
</code></pre></div><h2 id="12-targets">1.2: Targets</h2>
<p>To get a list of targets within the <code>examples/</code> folder, use a query.
This says <em>&ldquo;Ok bazel, show me all the callable targets in all packages
within the examples folder, and say what kind of thing it is in
addition to its path label&rdquo;</em>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/rules_protobuf$ bazel query //examples/... --output label_kind | sort | column -t

cc_binary                   rule  //examples/helloworld/cpp:client
cc_binary                   rule  //examples/helloworld/cpp:server
cc_library                  rule  //examples/helloworld/cpp:clientlib
cc_library                  rule  //examples/helloworld/proto:cpp
cc_library                  rule  //examples/proto:cpp
cc_proto_compile            rule  //examples/helloworld/proto:cpp.pb
cc_proto_compile            rule  //examples/proto:cpp.pb
cc_test                     rule  //examples/helloworld/cpp:test
filegroup                   rule  //examples/helloworld/proto:protos
filegroup                   rule  //examples/proto:protos
go_binary                   rule  //examples/helloworld/go/client:client
go_binary                   rule  //examples/helloworld/go/server:server
go_library                  rule  //examples/helloworld/go/server:greeter
go_library                  rule  //examples/helloworld/grpc_gateway:gateway
go_library                  rule  //examples/helloworld/proto:go
go_library                  rule  //examples/proto:go_default_library
go_proto_compile            rule  //examples/helloworld/proto:go.pb
go_proto_compile            rule  //examples/proto:go_default_library.pb
go_test                     rule  //examples/helloworld/go/greeter_test:greeter_test
go_test                     rule  //examples/helloworld/grpc_gateway:greeter_test
grpc_gateway_proto_compile  rule  //examples/helloworld/grpc_gateway:gateway.pb
java_binary                 rule  //examples/helloworld/java/org/pubref/rules_protobuf/examples/helloworld/client:netty
java_binary                 rule  //examples/helloworld/java/org/pubref/rules_protobuf/examples/helloworld/server:netty
java_library                rule  //examples/helloworld/java/org/pubref/rules_protobuf/examples/helloworld/client:client
java_library                rule  //examples/helloworld/java/org/pubref/rules_protobuf/examples/helloworld/server:server
java_library                rule  //examples/helloworld/proto:java
java_library                rule  //examples/proto:java
java_proto_compile          rule  //examples/helloworld/proto:java.pb
java_proto_compile          rule  //examples/proto:java.pb
js_proto_compile            rule  //examples/helloworld/proto:js
js_proto_compile            rule  //examples/proto:js
py_proto_compile            rule  //examples/helloworld/proto:py.pb
ruby_proto_compile          rule  //examples/proto:rb.pb
</code></pre></div><p>We&rsquo;re not limited to targets in our own workspace.  As it turns out,
the <a href="https://github.com/google/protobuf" target="_blank" rel="noopener">Google Protobuf repo<i class="fas fa-external-link-alt"></i></a> is
named as an external repository (more on this later) and we can also
address targets in that workspace in the same way.  Here&rsquo;s a partial
list:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/rules_protobuf$ bazel query @com_github_google_protobuf//... --output label_kind | sort | column -t

cc_binary       rule  @com_github_google_protobuf//:protoc
cc_library      rule  @com_github_google_protobuf//:protobuf
cc_library      rule  @com_github_google_protobuf//:protobuf_lite
cc_library      rule  @com_github_google_protobuf//:protoc_lib
cc_library      rule  @com_github_google_protobuf//util/python:python_headers
filegroup       rule  @com_github_google_protobuf//:well_known_protos
java_library    rule  @com_github_google_protobuf//:protobuf_java
objc_library    rule  @com_github_google_protobuf//:protobuf_objc
py_library      rule  @com_github_google_protobuf//:protobuf_python
...
</code></pre></div><p>This is possible because the protobuf team provides a
<a href="https://github.com/google/protobuf/blob/master/BUILD" target="_blank" rel="noopener">BUILD file<i class="fas fa-external-link-alt"></i></a> at
the root of their repository.  Thanks Protobuf team!  Later we&rsquo;ll
learn how to &ldquo;inject&rdquo; our own BUILD files into repositories that don&rsquo;t
already have one.</p>
<p>Inspecting the list above, we see a <code>cc_binary</code> rule named <code>protoc</code>.
If we <code>bazel run</code> that target, bazel will clone the protobuf repo,
build all the dependent libraries, build a pristine executable binary
from source, and call it (pass command line arguments to binary rules
after the double-dash):</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/rules_protobuf$ bazel run @com_github_google_protobuf//:protoc -- --help
Usage: /private/var/tmp/_bazel_pcj/63330772b4917b139280caef8bb81867/execroot/rules_protobuf/bazel-out/local-fastbuild/bin/external/com_github_google_protobuf/protoc <span style="color:#555">[</span>OPTION<span style="color:#555">]</span> PROTO_FILES
Parse PROTO_FILES and generate output based on the options given:
  -IPATH, --proto_path<span style="color:#555">=</span>PATH   Specify the directory in which to search <span style="color:#069;font-weight:bold">for</span>
                              imports.  May be specified multiple times;
                              directories will be searched in order.  If not
                              given, the current working directory is used.
  --version                   Show version info and exit.
  -h, --help                  Show this text and exit.
...
</code></pre></div><p>As we&rsquo;ll see in a moment, <em>we name the protobuf external dependency
with a specific commit ID so there&rsquo;s no ambiguity about which protoc
version we&rsquo;re using</em>.  In this way you can vendor in tools with your
project with reliable, repeable, secure precision without bloating
your repository by checking in binaries, resorting to git submodules,
or similar hacks.  Very clean!</p>
<blockquote>
<p>Note: the gRPC repository also has a BUILD file: <code>$ bazel query @com_github_grpc_grpc//... --output label_kind</code></p>
</blockquote>
<h2 id="13-target-pattern-syntax">1.3: Target Pattern Syntax</h2>
<p>With those examples under our belt, let&rsquo;s examine the target syntax a
bit more.  When I first started working with bazel I found the
target-pattern syntax somewhat intimidating.  It&rsquo;s actually not too
bad. Here&rsquo;s a closer look:</p>
<p>

<figure class="text-center">
  <img class="modal-trigger" src="/img/target-pattern-syntax.png"  id="target-pattern-syntax" data-toggle="modal" data-target="#modal-target-pattern-syntax"/>

  <div class="modal" id="modal-target-pattern-syntax">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-body">
        <img src="/img/target-pattern-syntax.png" />
      </div>
  </div>
</figure>
</p>
<ul>
<li>
<p>The <code>@</code> (at-sign) selects an external workspace. These are
established by
<a href="https://bazel.io/docs/be/workspace.html#workspace-rules" target="_blank" rel="noopener">workspace rules<i class="fas fa-external-link-alt"></i></a>
that bind a name to something fetched over the network (or your
filesystem).</p>
</li>
<li>
<p>The <code>//</code> (double-slash) selects the workspace root.</p>
</li>
<li>
<p>The <code>:</code> (colon) selects a target (rule or file) within a <em>package</em>.
Recall that a package is established by the presence of a <code>BUILD</code>
file in a subfolder of the workspace.</p>
</li>
<li>
<p>The <code>/</code> (single-slash) selects a folder within a workspace or
package.</p>
</li>
</ul>
<blockquote>
<p>A common source of confusion is that the mere presence of a
BUILD file defines that filesystem subtree as a package and
therefore one must always account for that.  For example, if there
exists a file <code>qux.js</code> in <code>foo/bar/baz/</code> and there exists a BUILD
file in <code>baz/</code> also, the file is selected with <code>foo/bar/baz:qux.js</code>
and not <code>foo/bar/baz/quz.js</code></p>
</blockquote>
<p><em>Common shortcut</em>: if there exists a rule having the same name as the
package, this is the implied target and can be omitted.  For example,
there is a <code>:jar</code> target in the <code>//jar</code> package in the external
workspace <code>com_google_guava_guava</code>, so the following are eqivalent:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">deps <span style="color:#555">=</span> [<span style="color:#c30">&#34;@com_google_guava_guava//jar:jar&#34;</span>]
deps <span style="color:#555">=</span> [<span style="color:#c30">&#34;@com_google_guava_guava//jar&#34;</span>]
</code></pre></div><h2 id="14-external-dependencies-workspace-rules">1.4: External Dependencies: Workspace Rules</h2>
<p>Many large organizations check-in in all the required tools,
compilers, linkers, etc to guarantee correct, repeatable builds.  With
external workspaces, one can effectively accomplish the same thing
without bloating your repository.</p>
<blockquote>
<p>Note: the bazel convention is to use a fully-namespaced identifier
for external dependency names (replacing special chars with
underscore).  For example, the remote repository URL is
<a href="https://github.com/google/protobuf.git">https://github.com/google/protobuf.git</a>.  This is simplified to the
workspace identifier com_github_google_protobuf.  Similarly, by
convention the jar artifact <code>io.grpc:grpc-netty:jar:1.0.0-pre1</code>
becomes <code>io_grpc_grpc_netty</code>.</p>
</blockquote>
<h3 id="141-workspace-rules-that-require-a-pre-existing-workspace">1.4.1: Workspace Rules that require a pre-existing WORKSPACE</h3>
<p>These rules assume that the remote resource or URL contains a
WORKSPACE file at the top of the file tree and BUILD files that define
rule targets.  These are referred to as <em>bazel repositories</em>.</p>
<ul>
<li>
<p><a href="https://bazel.io/docs/be/workspace.html#git_repository" target="_blank" rel="noopener">git_repository<i class="fas fa-external-link-alt"></i></a>:
external bazel dependency from a git repository.  The rule requires
<code>commit</code> (or <code>tag</code>).</p>
</li>
<li>
<p><a href="https://bazel.io/docs/be/workspace.html#http_archive" target="_blank" rel="noopener">http_archive<i class="fas fa-external-link-alt"></i></a>:
an external zip or tar.gz dependency from a URL. It is highly
recommended to name a sha265 for security.</p>
</li>
</ul>
<blockquote>
<p>Note: although you don&rsquo;t interact directly with the bazel
execution_root, you can peek at what these external dependencies
look like when unpacked at <code>$(bazel info execution_root)/external/WORKSPACE_NAME</code>.</p>
</blockquote>
<h3 id="142-workspace-rules-that-autogenerate-a-workspace-file-for-you">1.4.2: Workspace Rules that autogenerate a WORKSPACE file for you</h3>
<p>The implementation of these repository rules contain logic to
autogenerate a WORKSPACE file and BUILD file(s) to make resources
available. As always, it is recommended to provide a known sha265 for
security to prevent a malicious agent from slipping in tainted code
via a compromised network.</p>
<ul>
<li>
<p><a href="https://bazel.io/docs/be/workspace.html#http_jar" target="_blank" rel="noopener">http_jar<i class="fas fa-external-link-alt"></i></a>:
external jar from a URL. The jar file is available as a
<code>java_library</code> dependency as <code>@WORKSPACE_NAME//jar</code>.</p>
</li>
<li>
<p><a href="https://bazel.io/docs/be/workspace.html#maven_jar" target="_blank" rel="noopener">maven_jar<i class="fas fa-external-link-alt"></i></a>:
external jar from a URL. The jar file is available as a
<code>java_library</code> dependency as <code>@WORKSPACE_NAME//jar</code>.</p>
</li>
<li>
<p><a href="https://bazel.io/docs/be/workspace.html#http_file" target="_blank" rel="noopener">http_file<i class="fas fa-external-link-alt"></i></a>:
external file from a URL. The resource is available as a <code>filegroup</code>
via <code>@WORKSPACE_NAME//file</code>.</p>
</li>
</ul>
<p>For example, we can peek at the generated BUILD file for the
<code>maven_jar</code> guava dependency via:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/rules_protobuf$ cat <span style="color:#069;font-weight:bold">$(</span>bazel info execution_root<span style="color:#069;font-weight:bold">)</span>/external/com_google_guava_guava/jar/BUILD
</code></pre></div><div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#09f;font-style:italic"># DO NOT EDIT: automatically generated BUILD file for maven_jar rule com_google_guava_guava</span>
java_import(
    name <span style="color:#555">=</span> <span style="color:#c30">&#39;jar&#39;</span>,
    jars <span style="color:#555">=</span> [<span style="color:#c30">&#39;guava-19.0.jar&#39;</span>],
    visibility <span style="color:#555">=</span> [<span style="color:#c30">&#39;//visibility:public&#39;</span>]
)

filegroup(
    name <span style="color:#555">=</span> <span style="color:#c30">&#39;file&#39;</span>,
    srcs <span style="color:#555">=</span> [<span style="color:#c30">&#39;guava-19.0.jar&#39;</span>],
    visibility <span style="color:#555">=</span> [<span style="color:#c30">&#39;//visibility:public&#39;</span>]
)
</code></pre></div><blockquote>
<p>Note: the external workspace directory won&rsquo;t exist until you
actually need it, so you&rsquo;ll have to have built a target that
requires it, such as <code>bazel build examples/helloworld/java/org/pubref/rules_protobuf/examples/helloworld/client</code></p>
</blockquote>
<h3 id="143-workspace-rules-that-accept-a-build-file-as-an-argument">1.4.3: Workspace Rules that accept a BUILD file as an argument</h3>
<p>If a repository has no BUILD file(s), you can put one into its
filesystem root to adapt the external resource into bazel&rsquo;s worldview
and make those resources available to your project.</p>
<p>For example, consider
<a href="https://github.com/madler/zlib" target="_blank" rel="noopener">Mark Adler&rsquo;s zlib library<i class="fas fa-external-link-alt"></i></a>. To start,
let&rsquo;s learn what depends on this code.  This query says &ldquo;<em>Ok bazel,
for all targets in examples, find all dependencies (a transitive
closure set), then tell me which ones depend on the zlib target in the
root package of the external workspace com_github_madler_zlib.</em>&rdquo; Bazel
reports this reverse dependency set.  We request the output in
graphviz format and pipe this to dot to generate the figure:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/rules_protobuf$ bazel query <span style="color:#c30">&#34;rdeps(deps(//examples/...), @com_github_madler_zlib//:zlib)&#34;</span> <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>                  --output graph | dot -Tpng -O
</code></pre></div><p>

<figure class="text-center">
  <img class="modal-trigger" src="/img/zlib-deps.png"  id="zlib-deps" data-toggle="modal" data-target="#modal-zlib-deps"/>

  <div class="modal" id="modal-zlib-deps">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-body">
        <img src="/img/zlib-deps.png" />
      </div>
  </div>
</figure>
</p>
<p>So we can see that all grpc-related C code ultimately depends on this
library.  But, there is no BUILD file in Mark&rsquo;s repo&hellip; where did it
come from?</p>
<p>By using the variant workspace rule <code>new_git_repository</code>, we can
provide our
<a href="https://github.com/pubref/rules_protobuf/blob/master/protobuf/build_file/com_github_madler_zlib.BUILD" target="_blank" rel="noopener">own BUILD file<i class="fas fa-external-link-alt"></i></a>
(which defines the <code>cc_library</code> target) as follows:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">new_git_repository(
  name <span style="color:#555">=</span> <span style="color:#c30">&#34;com_github_madler_zlib&#34;</span>,
  remote <span style="color:#555">=</span> <span style="color:#c30">&#34;https://github.com/madler/zlib&#34;</span>,
  tag: <span style="color:#c30">&#34;v1.2.8&#34;</span>,
  build_file: <span style="color:#c30">&#34;//bzl:build_file/com_github_madler_zlib.BUILD&#34;</span>,
)
</code></pre></div><p>This <code>new_*</code> family of workspace rules keeps your repository lean and
allows you to vendor in pretty much any type of network-available
resource.  Awesome!</p>
<ul>
<li><a href="https://bazel.io/docs/be/workspace.html#new_git_repository" target="_blank" rel="noopener">new_git_repository<i class="fas fa-external-link-alt"></i></a></li>
<li><a href="https://bazel.io/docs/be/workspace.html#new_local_repository" target="_blank" rel="noopener">new_local_repository<i class="fas fa-external-link-alt"></i></a></li>
<li><a href="https://bazel.io/docs/be/workspace.html#new_http_archive" target="_blank" rel="noopener">new_http_archive<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<blockquote>
<p>You can also
<a href="https://bazel.io/docs/skylark/repository_rules.html" target="_blank" rel="noopener">write your own repository rules<i class="fas fa-external-link-alt"></i></a>
that have custom logic to pull resources from the net and bind it
into bazel&rsquo;s view of the universe.</p>
</blockquote>
<h2 id="15-bazel-summary">1.5: Bazel Summary</h2>
<p>When presented with a command and a target-pattern, bazel goes through
the following three phases:</p>
<ol>
<li>
<p>Loading: Read the WORKSPACE and required BUILD files. Generate a
dependency graph.</p>
</li>
<li>
<p>Analysis: for all nodes in the graph, which nodes are actually
required for this build? Do we have all the necessary
resources available?</p>
</li>
<li>
<p>Execution: execute each required node in the dependency graph and
generate outputs.</p>
</li>
</ol>
<p>Hopefully you now have enough conceptual knowledge of bazel to be
productive.</p>
<h2 id="16-rules_protobuf">1.6: rules_protobuf</h2>
<p><a href="https://github.com/pubref/rules_protobuf" target="_blank" rel="noopener">rules_protobuf<i class="fas fa-external-link-alt"></i></a> is an
extension to bazel that takes care of:</p>
<ol>
<li>
<p>Building the protocol buffer compiler <code>protoc</code>,</p>
</li>
<li>
<p>Downloading and/or building all the necessary protoc-gen plugins.</p>
</li>
<li>
<p>Downloading and/or building all the necessary gRPC-related support
libraries.</p>
</li>
<li>
<p>Invoking protoc for you (on demand), smoothing out the
idiosyncracies of different protoc plugins.</p>
</li>
</ol>
<p>It works by passing one or more <code>proto_language</code> specifications to the
<code>proto_compile</code> rule.  A <code>proto_language</code> rule contains the metadata
about how to invoke the plugin and the predicted file outputs, while
the <code>proto_compile</code> rule interprets a <code>proto_language</code> spec and builds
the appropriate command-line arguments to <code>protoc</code>.  For example,
here&rsquo;s how we can generate outputs for multiple languages
simultaneously:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"> proto_compile(
   name <span style="color:#555">=</span> <span style="color:#c30">&#34;pluriproto&#34;</span>,
   protos <span style="color:#555">=</span> [<span style="color:#c30">&#34;:protos&#34;</span>],
   langs <span style="color:#555">=</span> [
       <span style="color:#c30">&#34;//cpp&#34;</span>,
       <span style="color:#c30">&#34;//csharp&#34;</span>,
       <span style="color:#c30">&#34;//closure&#34;</span>,
       <span style="color:#c30">&#34;//ruby&#34;</span>,
       <span style="color:#c30">&#34;//java&#34;</span>,
       <span style="color:#c30">&#34;//java:nano&#34;</span>,
       <span style="color:#c30">&#34;//python&#34;</span>,
       <span style="color:#c30">&#34;//objc&#34;</span>,
       <span style="color:#c30">&#34;//node&#34;</span>,
   ],
   verbose <span style="color:#555">=</span> <span style="color:#f60">1</span>,
   with_grpc <span style="color:#555">=</span> True,
 )
</code></pre></div><div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ bazel build :pluriproto
<span style="color:#09f;font-style:italic"># ************************************************************</span>
<span style="color:#366">cd</span> <span style="color:#069;font-weight:bold">$(</span>bazel info execution_root<span style="color:#069;font-weight:bold">)</span> <span style="color:#555">&amp;&amp;</span> bazel-out/host/bin/external/com_github_google_protobuf/protoc <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--plugin<span style="color:#555">=</span>protoc-gen-grpc-java<span style="color:#555">=</span>bazel-out/host/genfiles/third_party/protoc_gen_grpc_java/protoc_gen_grpc_java <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--plugin<span style="color:#555">=</span>protoc-gen-grpc<span style="color:#555">=</span>bazel-out/host/bin/external/com_github_grpc_grpc/grpc_cpp_plugin <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--plugin<span style="color:#555">=</span>protoc-gen-grpc-nano<span style="color:#555">=</span>bazel-out/host/genfiles/third_party/protoc_gen_grpc_java/protoc_gen_grpc_java <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--plugin<span style="color:#555">=</span>protoc-gen-grpc-csharp<span style="color:#555">=</span>bazel-out/host/genfiles/external/nuget_grpc_tools/protoc-gen-grpc-csharp <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--plugin<span style="color:#555">=</span>protoc-gen-go<span style="color:#555">=</span>bazel-out/host/bin/external/com_github_golang_protobuf/protoc_gen_go <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--descriptor_set_out<span style="color:#555">=</span>bazel-genfiles/examples/proto/pluriproto.descriptor_set <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--ruby_out<span style="color:#555">=</span>bazel-genfiles <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--python_out<span style="color:#555">=</span>bazel-genfiles <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--cpp_out<span style="color:#555">=</span>bazel-genfiles <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--grpc_out<span style="color:#555">=</span>bazel-genfiles <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--objc_out<span style="color:#555">=</span>bazel-genfiles <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--csharp_out<span style="color:#555">=</span>bazel-genfiles/examples/proto <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--java_out<span style="color:#555">=</span>bazel-genfiles/examples/proto/pluriproto_java.jar <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--javanano_out<span style="color:#555">=</span><span style="color:#033">ignore_services</span><span style="color:#555">=</span>true:bazel-genfiles/examples/proto/pluriproto_nano.jar <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--js_out<span style="color:#555">=</span><span style="color:#033">import_style</span><span style="color:#555">=</span>closure,error_on_name_conflict,binary,library<span style="color:#555">=</span>examples/proto/pluriproto:bazel-genfiles <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--js_out<span style="color:#555">=</span><span style="color:#033">import_style</span><span style="color:#555">=</span>commonjs,error_on_name_conflict,binary:bazel-genfiles <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--go_out<span style="color:#555">=</span><span style="color:#033">plugins</span><span style="color:#555">=</span>grpc,Mexamples/proto/common.proto<span style="color:#555">=</span>github.com/pubref/rules_protobuf/examples/proto/pluriproto:bazel-genfiles <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--grpc-java_out<span style="color:#555">=</span>bazel-genfiles/examples/proto/pluriproto_java.jar <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--grpc-nano_out<span style="color:#555">=</span><span style="color:#033">ignore_services</span><span style="color:#555">=</span>true:bazel-genfiles/examples/proto/pluriproto_nano.jar <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--grpc-csharp_out<span style="color:#555">=</span>bazel-genfiles/examples/proto <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>--proto_path<span style="color:#555">=</span>. <span style="color:#c30;font-weight:bold">\
</span><span style="color:#c30;font-weight:bold"></span>examples/proto/common.proto
<span style="color:#09f;font-style:italic"># ************************************************************</span>
examples/proto/common_pb.rb
examples/proto/pluriproto_java.jar
examples/proto/pluriproto_nano.jar
examples/proto/common_pb2.py
examples/proto/common.pb.h
examples/proto/common.pb.cc
examples/proto/common.grpc.pb.h
examples/proto/common.grpc.pb.cc
examples/proto/Common.pbobjc.h
examples/proto/Common.pbobjc.m
examples/proto/pluriproto.js
examples/proto/Common.cs
examples/proto/CommonGrpc.cs
examples/proto/common.pb.go
examples/proto/common_pb.js
examples/proto/pluriproto.descriptor_set
</code></pre></div><p>The various <code>*_proto_library</code> rules (that we&rsquo;ll be using below)
internally invoke this <code>proto_compile</code> rule, then consume the
generated outputs and compile them with the requisite libraries into
<code>.class</code>, <code>.so</code>, <code>.a</code> (or whatever) objects.</p>
<p>So let&rsquo;s <em>make something</em> already! We&rsquo;ll use bazel and rules_protobuf
to build a gRPC application.</p>
<h1 id="building">2: Building a gRPC service with rules_protobuf</h1>
<p>The application will involve communication between two
different gRPC services:</p>
<h2 id="21-services">2.1: Services</h2>
<ol>
<li>
<p><strong>The Greeter service</strong>: This is the familiar &ldquo;Hello World&rdquo; starter
example that accepts a request with a <code>user</code> argument and replies
back with the string <code>Hello {user}</code>.</p>
</li>
<li>
<p><strong>The GreeterTimer service</strong>: This gRPC service will repeatedly
call a Greeter service in batches and report back aggregate batch
times (in milliseconds).  In this way we can compare some average
rpc times for the different Greeter service implementations.</p>
</li>
</ol>
<blockquote>
<p>This is an informal benchmark intended only for demonstration of
building gRPC applications.  For more formal performance testing,
consult the
<a href="https://performance-dot-grpc-testing.appspot.com/explore?dashboard=5760820306771968" target="_blank" rel="noopener">gRPC performance dashboard<i class="fas fa-external-link-alt"></i></a>.</p>
</blockquote>
<h2 id="22-compiled-programs">2.2: Compiled Programs</h2>
<p>For the demo, we&rsquo;ll use 6 different compiled programs written in 4
languages:</p>
<ul>
<li>
<p>A <code>GreeterTimer</code> client (go).  This command-line interface requires
the <code>greetertimer.proto</code> service definition defined locally in the
<code>//proto:greetertimer.proto</code> file.</p>
</li>
<li>
<p>A <code>GreeterTimer</code> server (java).  This netty-based server requires
both the <code>//proto/greetertimer.proto</code> file and the proto definition
defined externally in
<code>@org_pubref_rules_protobuf//examples/helloworld/proto:helloworld.proto</code>.</p>
</li>
<li>
<p>Four <code>Greeter</code> server implementations (C++, java, go, and C#).
rules_protobuf already provides these example implementations, so
we&rsquo;ll just use them directly.</p>
</li>
</ul>
<h2 id="23-protobuf-definitions">2.3: Protobuf Definitions</h2>
<p>GreeterTimer accepts a unary <code>TimerRequest</code> and streams back a
sequence of <code>BatchReponse</code> until all messages have been processed, at
which point the remote procedure call is complete.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">service GreeterTimer {
  <span style="color:#09f;font-style:italic">// Unary request followed by multiple streamed responses.
</span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">// Response granularity will be set by the request batch size.
</span><span style="color:#09f;font-style:italic"></span>  rpc timeHello(TimerRequest) returns (stream BatchResponse);
}
</code></pre></div><p><code>TimerRequest</code> includes metadata about where to contact the Greeter
service, how many total RPC calls to make, and how frequent to stream
back a BatchResponse (configured via the batch size).</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">message TimerRequest {
  <span style="color:#09f;font-style:italic">// the host where the grpc server is running
</span><span style="color:#09f;font-style:italic"></span>  string host <span style="color:#555">=</span> <span style="color:#f60">1</span>;
  <span style="color:#09f;font-style:italic">// The port of the grpc server
</span><span style="color:#09f;font-style:italic"></span>  int32 port <span style="color:#555">=</span> <span style="color:#f60">2</span>;
  <span style="color:#09f;font-style:italic">// The total number of hellos
</span><span style="color:#09f;font-style:italic"></span>  int32 total <span style="color:#555">=</span> <span style="color:#f60">3</span>;
  <span style="color:#09f;font-style:italic">// The number of hellos before sending a BatchResponse.
</span><span style="color:#09f;font-style:italic"></span>  int32 batchSize <span style="color:#555">=</span> <span style="color:#f60">4</span>;
}
</code></pre></div><p><code>BatchResponse</code> reports the number of calls made in the batch, how
long the batch run took, and the number of remaining calls.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">message BatchResponse {
  <span style="color:#09f;font-style:italic">// The number of checks that are remaining, calculated relative to
</span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">// totalChecks in the request.
</span><span style="color:#09f;font-style:italic"></span>  int32 remaining <span style="color:#555">=</span> <span style="color:#f60">1</span>;
  <span style="color:#09f;font-style:italic">// The number of checks actually performed in this batch.
</span><span style="color:#09f;font-style:italic"></span>  int32 batchCount <span style="color:#555">=</span> <span style="color:#f60">2</span>;
  <span style="color:#09f;font-style:italic">// The number of checks that failed.
</span><span style="color:#09f;font-style:italic"></span>  int32 errCount <span style="color:#555">=</span> <span style="color:#f60">3</span>;
  <span style="color:#09f;font-style:italic">// The total time spent, expressed as a number of milliseconds per
</span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">// request batch size (total time spent performing batchSize number
</span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">// of health checks).
</span><span style="color:#09f;font-style:italic"></span>  int64 batchTimeMillis <span style="color:#555">=</span> <span style="color:#f60">4</span>;
}
</code></pre></div><p>The non-streaming <code>Greeter</code> service takes a unary <code>HelloRequest</code> and
responds with a single <code>HelloReply</code>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">service Greeter {
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}

message HelloRequest {
  string name <span style="color:#555">=</span> <span style="color:#f60">1</span>;
  common.Config config <span style="color:#555">=</span> <span style="color:#f60">2</span>;
}

message HelloReply {
  string message <span style="color:#555">=</span> <span style="color:#f60">1</span>;
}
</code></pre></div><blockquote>
<p>The <code>common.Config</code> message type is not particularly functional here
but serves to demonstrate the use of imports.  rules_protobuf can
help with more complex setups having multiple proto → proto
dependencies.</p>
</blockquote>
<h2 id="24-build-the-grpc_greetertimer-example-application">2.4: Build the grpc_greetertimer example application.</h2>
<p>This demo application can be cloned at
<a href="https://github.com/pubref/grpc_greetertimer" target="_blank" rel="noopener">https://github.com/pubref/grpc_greetertimer<i class="fas fa-external-link-alt"></i></a>.</p>
<h3 id="241-create-the-project-layout">2.4.1: Create the Project Layout</h3>
<p>Here&rsquo;s the directory layout and relevant BUILD files we&rsquo;ll be using:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~$ mkdir grpc_greetertimer <span style="color:#555">&amp;&amp;</span> <span style="color:#366">cd</span> grpc_greetertimer
~/grpc_greetertimer$ mkdir -p proto/ go/ java/org/pubref/grpc/greetertimer/
~/grpc_greetertimer$ touch WORKSPACE
~/grpc_greetertimer$ touch proto/BUILD
~/grpc_greetertimer$ touch proto/greetertimer.proto
~/grpc_greetertimer$ touch go/BUILD
~/grpc_greetertimer$ touch go/main.go
~/grpc_greetertimer$ touch java/org/pubref/grpc/greetertimer/BUILD
~/grpc_greetertimer$ touch java/org/pubref/grpc/greetertimer/GreeterTimerServer.java
</code></pre></div><h3 id="242-the-workspace">2.4.2: The WORKSPACE</h3>
<p>We&rsquo;ll begin by creating the <a href="https://github.com/pubref/grpc_greetertimer" target="_blank" rel="noopener">WORKSPACE<i class="fas fa-external-link-alt"></i></a> file with a
reference to the rules_protobuf repository.  We load the main
entrypoint skylark file
<a href="https://github.com/pubref/rules_protobuf/blob/master/protobuf/rules.bzl" target="_blank" rel="noopener">rules.bzl<i class="fas fa-external-link-alt"></i></a>
in the <code>//bzl</code> package and call its <code>protobuf_repositories</code> function
with the languages to we want to use (in this case <code>java</code> and <code>go</code>).
We also load <a href="https://github.com/bazelbuild/rules_go" target="_blank" rel="noopener">rules_go<i class="fas fa-external-link-alt"></i></a> for go
compile support (not shown).</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#09f;font-style:italic"># File //:WORKSPACE</span>
workspace(name <span style="color:#555">=</span> <span style="color:#c30">&#34;org_pubref_grpc_greetertimer&#34;</span>)

git_repository(
    name <span style="color:#555">=</span> <span style="color:#c30">&#34;org_pubref_rules_protobuf&#34;</span>,
    remote <span style="color:#555">=</span> <span style="color:#c30">&#34;https://github.com/pubref/rules_protobuf.git&#34;</span>,
    tag <span style="color:#555">=</span> <span style="color:#c30">&#34;v0.6.0&#34;</span>,
)

<span style="color:#09f;font-style:italic"># Load language-specific dependencies</span>
load(<span style="color:#c30">&#34;@org_pubref_rules_protobuf//java:rules.bzl&#34;</span>, <span style="color:#c30">&#34;java_proto_repositories&#34;</span>)
java_proto_repositories()

load(<span style="color:#c30">&#34;@org_pubref_rules_protobuf//go:rules.bzl&#34;</span>, <span style="color:#c30">&#34;go_proto_repositories&#34;</span>)
go_proto_repositories()
</code></pre></div><blockquote>
<p>Refer to the
<a href="https://github.com/pubref/rules_protobuf/protobuf/internal/repositories.bzl" target="_blank" rel="noopener">repositories.bzl file<i class="fas fa-external-link-alt"></i></a>,
if you are interested in inspecting the dependencies.</p>
</blockquote>
<p>Bazel won&rsquo;t actually <em>fetch</em> something unless we actually need it by
some other rule later, so let&rsquo;s go ahead and write some code.  We&rsquo;ll
store our protocol buffer sources in <code>//proto</code>, our java sources in
<code>//java</code>, and go source in <code>//go</code>.</p>
<blockquote>
<p>Note: go development within a bazel workspace is a little different
than vanilla go.  In particular, one does not have to adhere to a
typical <code>GOCODE</code> layout having a <code>src/</code>, <code>pkg/</code>, <code>bin/</code>
subdirectories.</p>
</blockquote>
<h3 id="243-the-greetertimer-server">2.4.3: The GreeterTimer Server</h3>
<p>The <a href="https://github.com/pubref/grpc_greetertimer/blob/master/java/org/pubref/grpc/greetertimer/GreeterTimerServer.java" target="_blank" rel="noopener">Java server&rsquo;s<i class="fas fa-external-link-alt"></i></a>
main job is to accept requests and then connect to the requested
Greeter service as a client.  The implementation counts down the
number of remaining messages and does a blocking <code>sayHello(request)</code>
for each one.  If the batchSize limit is met, the
<code>observer.onNext(response)</code> message is invoked, streaming back a
response to the client.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#09f;font-style:italic">/* File //java/org/pubref/grpc/greetertimer:GreeterTimerServer.java */</span>

  <span style="color:#069;font-weight:bold">while</span> <span style="color:#555">(</span>remaining<span style="color:#555">--</span> <span style="color:#555">&gt;</span> 0<span style="color:#555">)</span> <span style="color:#555">{</span>

    <span style="color:#069;font-weight:bold">if</span> <span style="color:#555">(</span>batchCount<span style="color:#555">++</span> <span style="color:#555">==</span> batchSize<span style="color:#555">)</span> <span style="color:#555">{</span>
      BatchResponse response <span style="color:#555">=</span> BatchResponse<span style="color:#555">.</span><span style="color:#309">newBuilder</span><span style="color:#555">()</span>
        <span style="color:#555">.</span><span style="color:#309">setRemaining</span><span style="color:#555">(</span>remaining<span style="color:#555">)</span>
        <span style="color:#555">.</span><span style="color:#309">setBatchCount</span><span style="color:#555">(</span>batchCount<span style="color:#555">)</span>
        <span style="color:#555">.</span><span style="color:#309">setBatchTimeMillis</span><span style="color:#555">(</span>batchTime<span style="color:#555">)</span>
        <span style="color:#555">.</span><span style="color:#309">setErrCount</span><span style="color:#555">(</span>errCount<span style="color:#555">)</span>
        <span style="color:#555">.</span><span style="color:#309">build</span><span style="color:#555">();</span>
      observer<span style="color:#555">.</span><span style="color:#309">onNext</span><span style="color:#555">(</span>response<span style="color:#555">);</span>
    <span style="color:#555">}</span>

    blockingStub<span style="color:#555">.</span><span style="color:#309">sayHello</span><span style="color:#555">(</span>HelloRequest<span style="color:#555">.</span><span style="color:#309">newBuilder</span><span style="color:#555">()</span>
                          <span style="color:#555">.</span><span style="color:#309">setName</span><span style="color:#555">(</span><span style="color:#c30">&#34;#&#34;</span> <span style="color:#555">+</span> remaining<span style="color:#555">)</span>
                          <span style="color:#555">.</span><span style="color:#309">build</span><span style="color:#555">());</span>
  <span style="color:#555">}</span>
<span style="color:#555">}</span>
</code></pre></div><h3 id="244-the-greetertimer-client">2.4.4: The GreeterTimer Client</h3>
<p>The <a href="https://github.com/pubref/grpc_greetertimer/blob/master/go/main.go" target="_blank" rel="noopener">Go client<i class="fas fa-external-link-alt"></i></a>
prepares a <code>TimerRequest</code> and gets back a stream interface from the
<code>client.TimeHello</code> method.  We call its <code>Recv()</code> method until EOF, at
which point the call is complete.  A summary of each BatchResponse is
simply printed out to the terminal.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#09f;font-style:italic">// File: //go:main.go
</span><span style="color:#09f;font-style:italic"></span>
<span style="color:#069;font-weight:bold">func</span> <span style="color:#c0f">submit</span>(client greeterTimer.GreeterTimerClient, request <span style="color:#555">*</span>greeterTimer.TimerRequest) <span style="color:#078;font-weight:bold">error</span> {
	stream, err <span style="color:#555">:=</span> client.<span style="color:#c0f">TimeHello</span>(context.<span style="color:#c0f">Background</span>(), request)
	<span style="color:#069;font-weight:bold">if</span> err <span style="color:#555">!=</span> <span style="color:#069;font-weight:bold">nil</span> {
		log.<span style="color:#c0f">Fatalf</span>(<span style="color:#c30">&#34;could not submit request: %v&#34;</span>, err)
	}
	<span style="color:#069;font-weight:bold">for</span> {
		batchResponse, err <span style="color:#555">:=</span> stream.<span style="color:#c0f">Recv</span>()
		<span style="color:#069;font-weight:bold">if</span> err <span style="color:#555">==</span> io.EOF {
			<span style="color:#069;font-weight:bold">return</span> <span style="color:#069;font-weight:bold">nil</span>
		}
		<span style="color:#069;font-weight:bold">if</span> err <span style="color:#555">!=</span> <span style="color:#069;font-weight:bold">nil</span> {
			log.<span style="color:#c0f">Fatalf</span>(<span style="color:#c30">&#34;error during batch recv: %v&#34;</span>, err)
			<span style="color:#069;font-weight:bold">return</span> err
		}
		<span style="color:#c0f">reportBatchResult</span>(batchResponse)
	}
}
</code></pre></div><h3 id="245-generate-the-go-protobufgrpc-code">2.4.5: Generate the go protobuf+gRPC code</h3>
<p>In our <code>//proto:BUILD</code> file, we have a <code>go_proto_library</code> rule loaded
from the rules_protobuf repository.  Internally, the rule declares to
bazel that it is responsible for creating <code>greetertimer.pb.go</code> output
file. This rule won&rsquo;t actually <em>do</em> anything unless we depend on it
somewhere else.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#09f;font-style:italic"># File: //proto:BUILD</span>
load(<span style="color:#c30">&#34;@org_pubref_rules_protobuf//go:rules.bzl&#34;</span>, <span style="color:#c30">&#34;go_proto_library&#34;</span>)

go_proto_library(
    name <span style="color:#555">=</span> <span style="color:#c30">&#34;go_default_library&#34;</span>,
    protos <span style="color:#555">=</span> [
        <span style="color:#c30">&#34;greetertimer.proto&#34;</span>,
    ],
    with_grpc <span style="color:#555">=</span> True,
)
</code></pre></div><p>The go client implementation depends on the <code>go_proto_library</code> as
source file provider to the <code>go_binary</code> rule.  We also pass in some
compile-time dependencies named in the
<code>GRPC_COMPILE_DEPS</code> list.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">load(<span style="color:#c30">&#34;@io_bazel_rules_go//go:def.bzl&#34;</span>, <span style="color:#c30">&#34;go_binary&#34;</span>)
load(<span style="color:#c30">&#34;@org_pubref_rules_protobuf//go:rules.bzl&#34;</span>, <span style="color:#c30">&#34;GRPC_COMPILE_DEPS&#34;</span>)

go_binary(
    name <span style="color:#555">=</span> <span style="color:#c30">&#34;hello_client&#34;</span>,
    srcs <span style="color:#555">=</span> [
        <span style="color:#c30">&#34;main.go&#34;</span>,
    ],
    deps <span style="color:#555">=</span> [
        <span style="color:#c30">&#34;//proto:go_default_library&#34;</span>,
    ] <span style="color:#555">+</span> GRPC_COMPILE_DEPS,
)
</code></pre></div><div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/grpc_greetertimer$ bazel build //go:client
</code></pre></div><p>Here&rsquo;s what happens when we invoke bazel to actually build the client
binary:</p>
<ol>
<li>
<p>Bazel checks to see if the inputs (files) that the binary depends
on have changed (by content hash and filestamps).  Bazel recognizes
that the output files for the <code>//proto:go_default_library</code> have not
been built.</p>
</li>
<li>
<p>Bazel checks to see if all the necessary inputs (including tools)
for the <code>go_proto_library</code> are available.  If not, download and
build all the necessary tools.  Then, invoke the rule.</p>
<ol>
<li>
<p>Fetch the <code>google/protobuf</code> repository and build <code>protoc</code> from
source (via a cc_binary rule).</p>
</li>
<li>
<p>Build the <code>protoc-gen-go</code> plugin from source (via a go_binary
rule).</p>
</li>
<li>
<p>Invoke <code>protoc</code> with the <code>protoc-gen-go</code> plugin with the
appropriate options and arguments.</p>
</li>
<li>
<p>Confirm that all the declared outputs of the <code>go_proto_library</code>
where actually built (should be in <code>bazel-bin/proto/greetertimer.pb.go</code>).</p>
</li>
</ol>
</li>
<li>
<p>Compile the generated <code>greetertimer.pb.go</code> with the client
<code>main.go</code> file, creating the <code>bazel-bin/go/client</code> executable.</p>
</li>
</ol>
<h3 id="246-generate-the-java-protobuf-libraries">2.4.6: Generate the java protobuf libraries</h3>
<p>The <code>java_proto_library</code> rule is functionally identical to the
<code>go_proto_library</code> rule.  However, instead of providing a <code>*.pb.go</code>
file, it bundles up all the generated outputs into a <code>*.srcjar</code> file
(which is then used as an input to the <code>java_library</code> rule).  This an
implementation detail of the java rule.  Here is how we build the
final java binary:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">java_binary(
    name <span style="color:#555">=</span> <span style="color:#c30">&#34;server&#34;</span>,
    main_class <span style="color:#555">=</span> <span style="color:#c30">&#34;org.pubref.grpc.greetertimer.GreeterTimerServer&#34;</span>,
    srcs <span style="color:#555">=</span> [
        <span style="color:#c30">&#34;GreeterTimerServer.java&#34;</span>,
    ],
    deps <span style="color:#555">=</span> [
        <span style="color:#c30">&#34;:timer_protos&#34;</span>,
        <span style="color:#c30">&#34;@org_pubref_rules_protobuf//examples/helloworld/proto:java&#34;</span>,
        <span style="color:#c30">&#34;@org_pubref_rules_protobuf//java:grpc_compiletime_deps&#34;</span>,
    ],
    runtime_deps <span style="color:#555">=</span> [
        <span style="color:#c30">&#34;@org_pubref_rules_protobuf//java:netty_runtime_deps&#34;</span>,
    ],
)
</code></pre></div><ol>
<li>
<p>The <code>:timer_protos</code> is a locally defined <code>java_proto_library</code> rule.</p>
</li>
<li>
<p>The <code>@org_pubref_rules_protobuf//examples/helloworld/proto:java</code> is
an external <code>java_proto_library</code> rule that generates the greeter service
client stub in our own workspace.</p>
</li>
<li>
<p>Finally, we name the compile-time and run-time dependencies for the
executable jar.  If these jar files have not yet been downloaded from
maven central, they will be fetch as soon as we need them:</p>
</li>
</ol>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/grpc_greetertimer$ bazel build java/org/pubref/grpc/greetertimer:server
~/grpc_greetertimer$ bazel build java/org/pubref/grpc/greetertimer:server_deploy.jar
</code></pre></div><p>This last form (having the extra <code>_deploy.jar</code>) is called an <em>implicit
target</em> of the <code>:server</code> rule.  When invoked this way, bazel will pack
up all the required classes and generate a standalone executable jar
that can be run independently in a jvm.</p>
<h3 id="247-run-it">2.4.7: Run it!</h3>
<p>First, we&rsquo;ll start a greeter server (one at a time):</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/grpc_greetertimer$ <span style="color:#366">cd</span> ~/rules_protobuf
~/rules_protobuf$ bazel run examples/helloworld/go/server
~/rules_protobuf$ bazel run examples/helloworld/cpp/server
~/rules_protobuf$ bazel run examples/helloworld/java/org/pubref/rules_protobuf/examples/helloworld/server:netty
~/rules_protobuf$ bazel run examples/helloworld/csharp/GreeterServer
INFO: Server started, listening on <span style="color:#f60">50051</span>
</code></pre></div><p>In a separate terminal, start the greetertimer server:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~/grpc_greetertimer$ bazel build //java/org/pubref/grpc/greetertimer:server_deploy.jar
~/grpc_greetertimer$ java -jar bazel-bin/java/org/pubref/grpc/greetertimer/server_deploy.jar
</code></pre></div><p>Finally, in a third terminal, invoke the greetertimer client:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#09f;font-style:italic"># Timings for the java server</span>
~/rules_protobuf$ bazel run examples/helloworld/java/org/pubref/rules_protobuf/examples/helloworld/server:netty

~/grpc_greeterclient$ bazel run //go:client -- -total_size <span style="color:#f60">10000</span> -batch_size <span style="color:#f60">1000</span>
17:31:04 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">8999</span> remaining<span style="color:#555">)</span>: 1.7 hellos/ms or ~590µs per hello
<span style="color:#09f;font-style:italic"># ... plus a few runs to warm up the jvm...</span>
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">8999</span> remaining<span style="color:#555">)</span>: 6.7 hellos/ms or ~149µs per hello
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">7998</span> remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">6997</span> remaining<span style="color:#555">)</span>: 8.9 hellos/ms or ~112µs per hello
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">5996</span> remaining<span style="color:#555">)</span>: 9.2 hellos/ms or ~109µs per hello
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">4995</span> remaining<span style="color:#555">)</span>: 9.4 hellos/ms or ~106µs per hello
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">3994</span> remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">2993</span> remaining<span style="color:#555">)</span>: 9.4 hellos/ms or ~107µs per hello
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">1992</span> remaining<span style="color:#555">)</span>: 9.4 hellos/ms or ~107µs per hello
17:31:13 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">991</span> remaining<span style="color:#555">)</span>: 9.1 hellos/ms or ~110µs per hello
17:31:14 <span style="color:#f60">991</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, -1 remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello<span style="color:#c30">```</span>

<span style="color:#c30">```</span>sh
<span style="color:#09f;font-style:italic"># Timings for the go server</span>
~/rules_protobuf$ bazel run examples/helloworld/go/server

~/grpc_greeterclient$ bazel run //go:client -- -total_size <span style="color:#f60">10000</span> -batch_size <span style="color:#f60">1000</span>
17:32:33 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">8999</span> remaining<span style="color:#555">)</span>: 7.5 hellos/ms or ~134µs per hello
17:32:33 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">7998</span> remaining<span style="color:#555">)</span>: 7.9 hellos/ms or ~127µs per hello
17:32:34 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">6997</span> remaining<span style="color:#555">)</span>: 7.8 hellos/ms or ~128µs per hello
17:32:34 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">5996</span> remaining<span style="color:#555">)</span>: 7.7 hellos/ms or ~130µs per hello
17:32:34 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">4995</span> remaining<span style="color:#555">)</span>: 7.9 hellos/ms or ~126µs per hello
17:32:34 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">3994</span> remaining<span style="color:#555">)</span>: 8.0 hellos/ms or ~125µs per hello
17:32:34 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">2993</span> remaining<span style="color:#555">)</span>: 7.6 hellos/ms or ~132µs per hello
17:32:34 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">1992</span> remaining<span style="color:#555">)</span>: 7.9 hellos/ms or ~126µs per hello
17:32:34 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">991</span> remaining<span style="color:#555">)</span>: 7.9 hellos/ms or ~127µs per hello
17:32:34 <span style="color:#f60">991</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, -1 remaining<span style="color:#555">)</span>: 7.8 hellos/ms or ~128µs per hello
</code></pre></div><div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#09f;font-style:italic"># Timings for the C++ server</span>
~/rules_protobuf$ bazel run examples/helloworld/cpp:server

~/grpc_greeterclient$ bazel run //go:client -- -total_size <span style="color:#f60">10000</span> -batch_size <span style="color:#f60">1000</span>
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">8999</span> remaining<span style="color:#555">)</span>: 9.1 hellos/ms or ~110µs per hello
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">7998</span> remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">6997</span> remaining<span style="color:#555">)</span>: 9.1 hellos/ms or ~110µs per hello
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">5996</span> remaining<span style="color:#555">)</span>: 8.6 hellos/ms or ~116µs per hello
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">4995</span> remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">3994</span> remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">2993</span> remaining<span style="color:#555">)</span>: 9.1 hellos/ms or ~110µs per hello
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">1992</span> remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello
17:33:10 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">991</span> remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello
17:33:11 <span style="color:#f60">991</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, -1 remaining<span style="color:#555">)</span>: 9.0 hellos/ms or ~111µs per hello
</code></pre></div><div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#09f;font-style:italic"># Timings for the C# server</span>
~/rules_protobuf$ bazel run examples/helloworld/csharp/GreeterServer

~/grpc_greeterclient$ bazel run //go:client -- -total_size <span style="color:#f60">10000</span> -batch_size <span style="color:#f60">1000</span>
17:34:37 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">8999</span> remaining<span style="color:#555">)</span>: 6.0 hellos/ms or ~166µs per hello
17:34:37 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">7998</span> remaining<span style="color:#555">)</span>: 6.7 hellos/ms or ~150µs per hello
17:34:37 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">6997</span> remaining<span style="color:#555">)</span>: 6.8 hellos/ms or ~148µs per hello
17:34:37 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">5996</span> remaining<span style="color:#555">)</span>: 6.8 hellos/ms or ~147µs per hello
17:34:37 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">4995</span> remaining<span style="color:#555">)</span>: 6.7 hellos/ms or ~150µs per hello
17:34:38 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">3994</span> remaining<span style="color:#555">)</span>: 6.7 hellos/ms or ~150µs per hello
17:34:38 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">2993</span> remaining<span style="color:#555">)</span>: 6.7 hellos/ms or ~149µs per hello
17:34:38 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">1992</span> remaining<span style="color:#555">)</span>: 6.7 hellos/ms or ~149µs per hello
17:34:38 <span style="color:#f60">1001</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, <span style="color:#f60">991</span> remaining<span style="color:#555">)</span>: 6.8 hellos/ms or ~148µs per hello
17:34:38 <span style="color:#f60">991</span> hellos <span style="color:#555">(</span><span style="color:#f60">0</span> errs, -1 remaining<span style="color:#555">)</span>: 6.8 hellos/ms or ~147µs per hello
</code></pre></div><p>The informal analysis demonstrated comparable timings for c++, go, and
java greeter service implementations.  The c++ server had the overall
fastest and most consistent performance.  The go implementation was
also very consistent, but slightly slower than C++.  Java demonstrated
some initial relative slowness likely due to the JVM warming up but
soon converged on timings similar to the C++ implementation.  C# has
consistent performance but marginally slower.</p>
<h2 id="25-summary">2.5: Summary</h2>
<p>Bazel assists in the construction of gRPC applications by providing a
capable build environment for services built in a multitude of
languages.  <a href="https://github.com/pubref/rules_protobuf/" target="_blank" rel="noopener">rules_protobuf<i class="fas fa-external-link-alt"></i></a> complements bazel by packaging up all the
dependencies needed and abstracting away the need to call protoc
directly.</p>
<p>In this workflow one does not need to check in the generated source code
(it is always generated on-demand within your workspace).  For
projects that <em>do</em> require this, one can use the <code>output_to_workspace</code> option to place the generated
files alongside the protobuf definitions.</p>
<p>Finally, rules_protobuf has full support for the
<a href="https://github.com/grpc-ecosystem/grpc-gateway" target="_blank" rel="noopener">grpc-gateway<i class="fas fa-external-link-alt"></i></a> project
via the
<a href="https://github.com/pubref/rules_protobuf/tree/master/grpc_gateway#grpc_gateway_proto_library" target="_blank" rel="noopener">grpc_gateway_proto_library<i class="fas fa-external-link-alt"></i></a>
and
<a href="https://github.com/pubref/rules_protobuf/tree/master/grpc_gateway#grpc_gateway_binary" target="_blank" rel="noopener">grpc_gateway_binary<i class="fas fa-external-link-alt"></i></a> rules, so you can easily bridge your gRPC apps with HTTP/1.1 gateways.</p>
<p>Refer to the <a href="https://github.com/pubref/rules_protobuf/#rules" target="_blank" rel="noopener">complete list of supported languages and gRPC versions<i class="fas fa-external-link-alt"></i></a> for more information.</p>
<p>And&hellip; that&rsquo;s a wrap.  Happy procedure calling!</p>
<blockquote>
<p>Paul Johnston is the principal at <a href="https://pubref.org" target="_blank" rel="noopener">PubRef<i class="fas fa-external-link-alt"></i></a>
(<a href="https://twitter.com/pub_ref" target="_blank" rel="noopener">@pub_ref<i class="fas fa-external-link-alt"></i></a>), a solutions provider for
scientific communications workflows.  If you have an organizational
need for assistance with Bazel, gRPC, or related technologies,
please contact <a href="mailto:pcj@pubref.org">pcj@pubref.org</a>.  Thanks!</p>
</blockquote>
	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/blog/vsco/" class="btn btn-primary "><span class="mr-1">←</span> Previous</a>
  </li>
    <a href="/blog/yikyak/" class="btn btn-primary ">Next <span class="ml-1">→</span></a>
  </li>
</ul>

	<div class="c-global-meta-links">
		
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
    
    
      
    
    
    
    
    
    
    

    <a href="https://github.com/grpc/grpc.io/edit/main/content/en/blog/bazel-rules-protobuf.md" target="_blank"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
    <a href="https://github.com/grpc/grpc.io/new/main/content/en/blog/bazel-rules-protobuf.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" target="_blank"><i class="fa fa-edit fa-fw"></i> Create child page</a>
    <a href="https://github.com/grpc/grpc.io/issues/new?title=Building%20gRPC%20services%20with%20bazel%20and%20rules_protobuf" target="_blank"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
    
      
      <a href="https://github.com/grpc/grpc.io/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
    

  
  
  </div>


	</div>
</div>

          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/grpcio">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Google Groups" aria-label="Google Groups">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://groups.google.com/g/grpc-io">
      <i class="fab fa-google"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Gitter" aria-label="Gitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://gitter.im/grpc/grpc">
      <i class="fab fa-gitter"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/grpc">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 gRPC Authors
          
        </small>
        
        
      </div>
    </div>
    <div class="row text-center text-white small">
      <div class="col-12 text-center py-2 order-sm-2">
        <a href="https://www.linuxfoundation.org/terms" target="_blank" rel="noopener">Terms</a> |
        <a href="https://www.linuxfoundation.org/privacy" target="_blank" rel="noopener">Privacy</a> |
        <a href="https://www.linuxfoundation.org/trademark-usage" target="_blank" rel="noopener">Trademarks</a> |
        <a href="https://github.com/grpc/grpc.io/blob/main/LICENSE" target="_blank" rel="noopener">License</a> |
        <a href="/about/">About</a>
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>











<script src="/js/main.min.d862e8117d34e02dff1772aeeb47caf7ed851d0f8a3a5345f7a32ccfb2f6b87f.js" integrity="sha256-2GLoEX004C3/F3Ku60fK9&#43;2FHQ&#43;KOlNF96Msz7L2uH8=" crossorigin="anonymous"></script>




  </body>
</html>