<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.82.1" />

<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/android-chrome-512x512.png" sizes="512x512">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/site.webmanifest">
<title>So You Want to Optimize gRPC - Part 1 | gRPC</title>
<meta property="og:title" content="So You Want to Optimize gRPC - Part 1" />
<meta property="og:description" content="A common question with gRPC is how to make it fast.  The gRPC library offers users access to high
performance RPCs, but it isn&rsquo;t always clear how to achieve this.  Because this question is common
enough I thought I would try to show my thought process when tuning programs." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Joevaen.github.io/blog/optimizing-grpc-part-1/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2018-03-06T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-12-16T23:13:50-08:00" /><meta property="og:site_name" content="gRPC" />

<meta itemprop="name" content="So You Want to Optimize gRPC - Part 1">
<meta itemprop="description" content="A common question with gRPC is how to make it fast.  The gRPC library offers users access to high
performance RPCs, but it isn&rsquo;t always clear how to achieve this.  Because this question is common
enough I thought I would try to show my thought process when tuning programs."><meta itemprop="datePublished" content="2018-03-06T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-12-16T23:13:50-08:00" />
<meta itemprop="wordCount" content="2576">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="So You Want to Optimize gRPC - Part 1"/>
<meta name="twitter:description" content="A common question with gRPC is how to make it fast.  The gRPC library offers users access to high
performance RPCs, but it isn&rsquo;t always clear how to achieve this.  Because this question is common
enough I thought I would try to show my thought process when tuning programs."/>



<link rel="preload" href="/css/style.min.e3cf82e558200e98b09736f835e12b188dca1353aad6649d3429c72923031431.css" as="style">
<link href="/css/style.min.e3cf82e558200e98b09736f835e12b188dca1353aad6649d3429c72923031431.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-163836834-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-163836834-2');
  gtag('config', 'UA-60127042-1');
</script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="canonical" href="https://Joevaen.github.io/blog/optimizing-grpc-part-1/">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@grpcio">
<meta name="twitter:creator" content="@grpcio">
<meta name="twitter:image" content="https://Joevaen.github.io/img/logos/grpc-icon-color.png">
<meta name="twitter:image:alt" content="gRPC color logo">

<meta property="og:url" content="https://Joevaen.github.io/blog/optimizing-grpc-part-1/">
<meta property="og:title" content="So You Want to Optimize gRPC - Part 1">
<meta property="og:description" content="A high-performance, open source universal RPC framework">
<meta property="og:type" content="article">
<meta property="og:site_name" content="gRPC">
<meta property="og:image" content="https://Joevaen.github.io/img/logos/grpc-icon-color.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:alt" content="gRPC color logo">
<meta property="og:locale" content="en_US">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/android-chrome-512x512.png" sizes="512x512">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/site.webmanifest">

  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="672pt" height="436pt" viewBox="0 0 672 436"><g transform="translate(0.000000,436.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M3066 3659c-376-41-707-264-894-602-35-63-50-101-45-113 4-12 3-15-5-10s-10 1-5-10c5-13 9-11 23 15 9 18 19 29 22 25 4-3 4 3 1 15-4 14-1 21 9 21 8 0 27 23 42 51 119 218 360 416 607 499 96 33 250 60 337 60 551 0 1009-390 1097-933 48-296-20-597-193-847-24-36-35-56-23-46 35 32 24 2-23-61-49-64-119-128-220-198-36-26-66-49-66-51 0-10 123 74 187 128 63 53 173 174 182 201 2 7 9 19 16 27s36 58 63 110c198 373 185 786-35 1159-25 42-60 95-79 118-42 51-45 68-4 22 68-76 190-285 190-326 0-7 5-12 11-10 6 1 14-4 17-12 2-8 0-11-5-8-6 4-8-4-5-19 3-18 7-22 12-13 6 8 12-2 19-29 6-23 15-59 21-80 31-121 29-332-5-516-9-44-13-81-11-83s16 47 31 109c26 106 27 122 22 268-4 119-12 179-32 260-56 225-191 440-375 598-70 59-261 182-284 182-6 0 25-21 69-47 44-25 105-65 135-89 62-48 149-134 135-134-6 0-32 23-60 51-67 67-224 171-325 215-78 34-249 83-294 85-21 0-21 1-1 9 15 7 8 9-30 10-27 0-72 2-1e2 4-27 2-86 0-129-5z"/><path d="M36e2 3580c8-5 20-10 25-10 6 0 3 5-5 10s-19 10-25 10c-5 0-3-5 5-10z"/><path d="M3519 3276c-69-18-136-62-211-138-191-194-325-488-288-630 12-45 45-88 67-88 18 0 16 19-2 27-24 9-45 57-45 103 0 121 141 397 271 531 111 115 241 189 303 173 1e2-25 76-265-64-626l-40-105-58-13c-79-17-211-65-309-110-197-92-359-233-429-375-35-71-39-87-39-154 0-65 4-83 28-123 61-104 188-133 299-70 70 41 176 152 251 265 67 102 188 333 243 464 37 89 39 92 79 102 43 11 84 36 74 45-3 3-24-2-47-11s-45-14-48-11 15 63 41 133c126 349 145 579 49 615-33 13-68 12-125-4zm-29-794c0-4-47-102-104-218-197-398-362-594-5e2-594-68 0-124 44-151 119-85 243 203 545 645 675 93 27 110 30 110 18z"/><path d="M2081 2794c0-11 3-14 6-6 3 7 2 16-1 19-3 4-6-2-5-13z"/><path d="M4291 2784c0-11 3-14 6-6 3 7 2 16-1 19-3 4-6-2-5-13z"/><path d="M2071 2754c0-11 3-14 6-6 3 7 2 16-1 19-3 4-6-2-5-13z"/><path d="M4302 2740c0-14 2-19 5-12 2 6 2 18 0 25-3 6-5 1-5-13z"/><path d="M2061 2714c0-11 3-14 6-6 3 7 2 16-1 19-3 4-6-2-5-13z"/><path d="M2052 2660c0-14 2-19 5-12 2 6 2 18 0 25-3 6-5 1-5-13z"/><path d="M2043 2585c0-22 2-30 4-17 2 12 2 30 0 40-3 9-5-1-4-23z"/><path d="M4252 2018c-15-37-19-55-11-63 7-7 8-4 3 9-6 15-4 17 6 11 9-5 11-4 6 3-4 7-3 12 3 12s7 7 4 17c-5 12-3 14 8 8 8-4 11-5 7 0-4 4-4 13 2 19 5 7 5 17 1 24s-15-8-29-40z"/><path d="M4205 1919c-3-4 2-6 10-5 21 3 28 13 10 13-9 0-18-4-20-8z"/><path d="M4024 1668l-19-23 23 19c12 11 22 21 22 23 0 8-8 2-26-19z"/><path d="M4015 1628l-40-43 43 40c39 36 47 45 39 45-2 0-21-19-42-42z"/><path d="M3969 1613c-13-16-12-17 4-4s21 21 13 21c-2 0-10-8-17-17z"/><path d="M3919 1543c-13-16-12-17 4-4 9 7 17 15 17 17 0 8-8 3-21-13z"/><path d="M3705 1428c-11-6-23-15-26-20-3-6-9-9-13-9-19 3-27 0-22-7 7-12-61-35-75-26-8 5-9 3-4-6 6-10 3-12-13-8-14 4-20 2-15-5 4-6-2-8-15-5-12 4-20 2-17-2 3-5 0-10-7-13-7-2-2-2 12 0 39 7 179 63 194 78 7 8 16 12 18 10 3-3 5 2 5 10s-1 15-1 15c-1 0-10-6-21-12z"/><path d="M3448 1313c7-3 16-2 19 1 4 3-2 6-13 5-11 0-14-3-6-6z"/><path d="M3355 13e2c-27-7-27-8-5-8 14 0 39 4 55 8 27 7 27 8 5 8-14 0-38-4-55-8z"/><path d="M3263 1283c9-2 25-2 35 0 9 3 1 5-18 5s-27-2-17-5z"/><path d="M1810 981c0-75-4-103-15-115-17-17-20-66-4-66 6 0 24 13 40 29 29 29 29 31 29 140v111h-25c-25 0-25 0-25-99z"/><path d="M2211 1062c-51-25-73-61-74-120-1-70 33-116 101-137 36-10 28 31-13 69-26 25-35 42-35 66s9 41 35 66c19 18 35 42 35 53 0 25-5 26-49 3z"/><path d="M2290 1060c0-12 16-36 35-54 26-25 35-42 35-66s-9-41-35-66c-41-38-49-79-12-69 66 20 99 65 99 135s-33 115-99 135c-19 5-23 2-23-15z"/><path d="M2692 1053l3-28h1e2 1e2l3 28 3 27h-106-106l3-27z"/><path d="M3150 1068c0-7 23-70 52-140 48-119 53-128 78-128s30 9 78 130c29 72 52 135 52 141s-12 9-27 7c-23-2-31-13-51-63-13-33-31-76-39-95l-14-35-25 59c-13 33-24 63-24 67s15 9 33 11c27 2 32 7 32 28 0 24-3 25-72 28-55 2-73 0-73-10z"/><path d="M3724 1003c-43-93-48-128-19-128 15 0 28 17 50 63l30 62 25-62c14-35 27-66 28-70 2-5-35-8-82-8-76 0-86-2-1e2-22-8-12-13-25-10-30 7-11 261-10 268 1 3 5-19 67-49 137-48 114-57 129-80 132s-29-4-61-75z"/><path d="M4187 1073c-4-3-7-14-7-24 0-25 28-31 125-27 79 3 80 3 83 31l3 27h-99c-54 0-102-3-105-7z"/><path d="M4670 1068c0-7 43-71 96-141 77-105 99-128 117-125 21 3 22 7 25 141l3 138-28-3c-28-3-28-4-33-86l-5-83-62 85c-50 69-68 86-88 86-14 0-25-6-25-12z"/><path d="M2694 955c-14-37 2-45 89-45 88 0 114 11 101 44-9 23-182 24-190 1z"/><path d="M4184 955c-3-8-3-22 0-30 5-13 22-15 98-13 92 3 93 3 93 28s-1 25-93 28c-76 2-93 0-98-13z"/><path d="M1675 890c-10-16 4-48 32-70 32-25 40-25 48 0 13 40-60 103-80 70z"/><path d="M4670 850c0-47 2-50 25-50s25 3 25 50-2 50-25 50-25-3-25-50z"/><path d="M2694 845c-3-8-3-22 0-30 5-13 23-15 103-13 97 3 98 3 98 28s-1 25-98 28c-80 2-98 0-103-13z"/><path d="M4184 845c-15-38 1-45 106-45h101l-3 28-3 27-98 3c-80 2-98 0-103-13z"/></g></svg></span><span class="text-uppercase font-weight-bold">gRPC</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs/" ><span>Docs</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/showcase/" ><span>Showcase</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>Blog</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/community/" ><span>Community</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    
<input type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/blog/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">
      
        gRPC Blog
      
    </a>
  </li>
  <ul>
    <li class="collapse show" id="blog">
      
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-csharp-future" href="/blog/grpc-csharp-future/">
            
              The future of gRPC in C# belongs to grpc-dotnet
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogwireshark" href="/blog/wireshark/">
            
              Analyzing gRPC messages using Wireshark
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-web-interceptor" href="/blog/grpc-web-interceptor/">
            
              Interceptors in gRPC-Web
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-js-10" href="/blog/grpc-js-1.0/">
            
              Announcing gRPC-JS 1.0
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogkotlin-meet-grpc" href="/blog/kotlin-meet-grpc/">
            
              Kotlin, meet gRPC
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-cloud-run" href="/blog/grpc-cloud-run/">
            
              gRPC comes to Cloud Run
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogcmake-improvements" href="/blog/cmake-improvements/">
            
              Improvements to gRPC&#39;s CMake Build System
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-on-dotnetcore" href="/blog/grpc-on-dotnetcore/">
            
              .NET Core ❤ gRPC
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloghello-pancakes" href="/blog/hello-pancakes/">
            
              Dear gRPC
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogstate-of-grpc-web" href="/blog/state-of-grpc-web/">
            
              The state of gRPC in the browser
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-stacks" href="/blog/grpc-stacks/">
            
              Visualizing gRPC Language Stacks
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-web-ga" href="/blog/grpc-web-ga/">
            
              gRPC-Web is Generally Available
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloga-short-introduction-to-channelz" href="/blog/a-short-introduction-to-channelz/">
            
              A short introduction to Channelz
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-on-http2" href="/blog/grpc-on-http2/">
            
              gRPC on HTTP/2 Engineering a Robust, High-performance Protocol
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-with-json" href="/blog/grpc-with-json/">
            
              gRPC &#43; JSON
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogtake-the-grpc-survey" href="/blog/take-the-grpc-survey/">
            
              Take the gRPC Survey!
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggraceful-cleanup-junit-tests" href="/blog/graceful-cleanup-junit-tests/">
            
              Gracefully clean up in gRPC JUnit tests
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-dotnet-build" href="/blog/grpc-dotnet-build/">
            
              gRPC Meets .NET SDK And Visual Studio: Automatic Codegen On Build
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogkotlin-gradle-projects" href="/blog/kotlin-gradle-projects/">
            
              gRPC ❤ Kotlin
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogoptimizing-grpc-part-2" href="/blog/optimizing-grpc-part-2/">
            
              So You Want to Optimize gRPC - Part 2
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page  active" id="m-blogoptimizing-grpc-part-1" href="/blog/optimizing-grpc-part-1/">
            
              So You Want to Optimize gRPC - Part 1
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogdeadlines" href="/blog/deadlines/">
            
              gRPC and Deadlines
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-go-engineering-practices" href="/blog/grpc-go-engineering-practices/">
            
              gRPC-Go Engineering Practices
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogmeetup-kit" href="/blog/meetup-kit/">
            
              The gRPC Meetup Kit
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-go-perf-improvements" href="/blog/grpc-go-perf-improvements/">
            
              gRPC-Go performance Improvements
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogcommunity-meeting-update" href="/blog/community-meeting-update/">
            
              2017-08-17 Community Meeting Update
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-flatbuffers" href="/blog/grpc-flatbuffers/">
            
              Announcing out-of-the-box support for gRPC in the Flatbuffers serialization library
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloggrpc-load-balancing" href="/blog/grpc-load-balancing/">
            
              gRPC Load Balancing
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloghelm-grpc" href="/blog/helm-grpc/">
            
              gRPC in Helm
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogyikyak" href="/blog/yikyak/">
            
              Migration to Google Cloud Platform — gRPC &amp; grpc-gateway
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogbazel-rules-protobuf" href="/blog/bazel-rules-protobuf/">
            
              Building gRPC services with bazel and rules_protobuf
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogvsco" href="/blog/vsco/">
            
              gRPC at VSCO
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogvendasta" href="/blog/vendasta/">
            
              Why we have decided to move our APIs to gRPC
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogga-announcement" href="/blog/ga-announcement/">
            
              gRPC Project is now 1.0 and ready for production deployments
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogmobile-benchmarks" href="/blog/mobile-benchmarks/">
            
              Mobile Benchmarks
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogcoreos" href="/blog/coreos/">
            
              gRPC with REST and Open APIs
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-bloginstallation" href="/blog/installation/">
            
              gRPC - now with easy installation
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogpubsub" href="/blog/pubsub/">
            
              Google Cloud PubSub - with the power of gRPC!
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogbeta-release" href="/blog/beta-release/">
            
              gRPC releases Beta, opening door for use in production environments
            
            </a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-blogprinciples" href="/blog/principles/">
            
              gRPC Motivation and Design Principles
            
            </a>
        
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
    
    
      
    
    
    
    
    
    
    

    <a href="https://github.com/grpc/grpc.io/edit/main/content/en/blog/optimizing-grpc-part-1.md" target="_blank"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
    <a href="https://github.com/grpc/grpc.io/new/main/content/en/blog/optimizing-grpc-part-1.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" target="_blank"><i class="fa fa-edit fa-fw"></i> Create child page</a>
    <a href="https://github.com/grpc/grpc.io/issues/new?title=So%20You%20Want%20to%20Optimize%20gRPC%20-%20Part%201" target="_blank"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
    
      
      <a href="https://github.com/grpc/grpc.io/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
    

  
  
  </div>





<nav id="TableOfContents">
  <ul>
    <li><a href="#setup">Setup</a></li>
    <li><a href="#starting-point">Starting Point</a>
      <ul>
        <li><a href="#client">Client</a></li>
        <li><a href="#server">Server</a></li>
        <li><a href="#performance">Performance</a></li>
      </ul>
    </li>
    <li><a href="#optimization">Optimization</a>
      <ul>
        <li><a href="#analysis">Analysis</a></li>
        <li><a href="#hypothesis">Hypothesis</a></li>
        <li><a href="#experiment">Experiment</a></li>
        <li><a href="#running-the-code">Running the Code</a></li>
        <li><a href="#results">Results</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            <a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href="https://Joevaen.github.io/blog/feed.xml" target="_blank">
              RSS <i class="fa fa-rss ml-2 "></i>
            </a>
            
<div class="td-content">
	<h1>So You Want to Optimize gRPC - Part 1</h1>
	
	<div class="td-byline mb-4">
    By
			<a href="https://github.com/carl-mastrangelo"><b>Carl Mastrangelo</b></a>
			 (Google) |
			<time datetime="2018-03-06" class="text-muted">Tuesday, March 06, 2018</time>
	</div>
	<div class="d-xl-none td-toc td-toc--inline d-print-none">
		
  
    
      <a id="td-content__toc-link" href="#td-content__toc" data-toggle="collapse" aria-controls="td-docs-toc" aria-expanded="false" aria-label="Toggle toc navigation">
        <span class="lead">Contents<i class="fas fa-chevron-right ml-2"></i></span>
      </a>
      <div id="td-content__toc" class="collapse">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#setup">Setup</a></li>
    <li><a href="#starting-point">Starting Point</a>
      <ul>
        <li><a href="#client">Client</a></li>
        <li><a href="#server">Server</a></li>
        <li><a href="#performance">Performance</a></li>
      </ul>
    </li>
    <li><a href="#optimization">Optimization</a>
      <ul>
        <li><a href="#analysis">Analysis</a></li>
        <li><a href="#hypothesis">Hypothesis</a></li>
        <li><a href="#experiment">Experiment</a></li>
        <li><a href="#running-the-code">Running the Code</a></li>
        <li><a href="#results">Results</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
      </div>
      <button id="td-content__toc-link-expanded" href="#td-content__toc" class="btn btn-small ml-1 my-2 py-0 px-3" data-toggle="collapse" aria-controls="td-docs-toc" aria-expanded="true" aria-label="Toggle toc navigation">
      </button>
    
  


	</div>
	
	<p>A common question with gRPC is how to make it fast.  The gRPC library offers users access to high
performance RPCs, but it isn&rsquo;t always clear how to achieve this.  Because this question is common
enough I thought I would try to show my thought process when tuning programs.</p>
<h2 id="setup">Setup</h2>
<p>Consider a basic key-value service that is used by multiple other programs.  The service needs to
be safe for concurrent access in case multiple updates happen at the same time.  It needs to be
able to scale up to use the available hardware.   Lastly, it needs to be fast.  gRPC is a perfect
fit for this type of service; let&rsquo;s look at the best way to implement it.</p>
<p>For this blog post, I have written an example
<a href="https://github.com/carl-mastrangelo/kvstore" target="_blank" rel="noopener">client and server<i class="fas fa-external-link-alt"></i></a> using gRPC Java. The program is
split into three main classes, and a protobuf file describing the API:</p>
<ul>
<li><a href="https://github.com/carl-mastrangelo/kvstore/blob/01-start/src/main/java/io/grpc/examples/KvClient.java" target="_blank" rel="noopener">KvClient<i class="fas fa-external-link-alt"></i></a>
is a simulated user of the key value system.   It randomly creates, retrieves, updates,
and deletes keys and values.  The size of keys and values it uses is also randomly decided
using an <a href="https://en.wikipedia.org/wiki/Exponential_distribution" target="_blank" rel="noopener">exponential distribution<i class="fas fa-external-link-alt"></i></a>.</li>
<li><a href="https://github.com/carl-mastrangelo/kvstore/blob/01-start/src/main/java/io/grpc/examples/KvService.java" target="_blank" rel="noopener">KvService<i class="fas fa-external-link-alt"></i></a>
is an implementation of the key value service.  It is installed by the gRPC Server to handle
the requests issued by the client.  To simulate storing the keys and values on disk, it adds
short sleeps while handling the request.  Reads and writes will experience a 10 and 50
millisecond delay to make the example act more like a persistent database.</li>
<li><a href="https://github.com/carl-mastrangelo/kvstore/blob/01-start/src/main/java/io/grpc/examples/KvRunner.java" target="_blank" rel="noopener">KvRunner<i class="fas fa-external-link-alt"></i></a>
orchestrates the interaction between the client and the server.  It is the main entry point,
starting both the client and server in process, and waiting for the the client to execute its
work.  The runner does work for 60 seconds and then records how many RPCs were completed.</li>
<li><a href="https://github.com/carl-mastrangelo/kvstore/blob/01-start/src/main/proto/kvstore.proto" target="_blank" rel="noopener">kvstore.proto<i class="fas fa-external-link-alt"></i></a>
is the protocol buffer definition of our service.  It describes exactly what clients can expect
from the service. For the sake of simplicity, we will use Create, Retrieve, Update, and Delete
as the operations (commonly known as CRUD).  These operations work with keys and values made up
of arbitrary bytes.  While they are somewhat REST like, we reserve the right to diverge and
add more complex operations in the future.</li>
</ul>
<p><a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="noopener">Protocol buffers<i class="fas fa-external-link-alt"></i></a> (protos) aren&rsquo;t required to use
gRPC, they are a very convenient way to define service interfaces and generate client and server
code. The generated code acts as glue code between the application logic and the core gRPC
library. We refer to the code called by a gRPC client the <em>stub</em>.</p>
<h2 id="starting-point">Starting Point</h2>
<h3 id="client">Client</h3>
<p>Now that we know what the program <em>should</em> do, we can start looking at how the program performs.
As mentioned above, the client makes random RPCs.  For example, here is the code that makes the
<a href="https://github.com/carl-mastrangelo/kvstore/blob/f422b1b6e7c69f8c07f96ed4ddba64757242352c/src/main/java/io/grpc/examples/KvClient.java#L80" target="_blank" rel="noopener">creation<i class="fas fa-external-link-alt"></i></a>
request:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#069;font-weight:bold">private</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">doCreate</span><span style="color:#555">(</span>KeyValueServiceBlockingStub stub<span style="color:#555">)</span> <span style="color:#555">{</span>
  ByteString key <span style="color:#555">=</span> createRandomKey<span style="color:#555">();</span>
  <span style="color:#069;font-weight:bold">try</span> <span style="color:#555">{</span>
    CreateResponse res <span style="color:#555">=</span> stub<span style="color:#555">.</span><span style="color:#309">create</span><span style="color:#555">(</span>
        CreateRequest<span style="color:#555">.</span><span style="color:#309">newBuilder</span><span style="color:#555">()</span>
            <span style="color:#555">.</span><span style="color:#309">setKey</span><span style="color:#555">(</span>key<span style="color:#555">)</span>
            <span style="color:#555">.</span><span style="color:#309">setValue</span><span style="color:#555">(</span>randomBytes<span style="color:#555">(</span>MEAN_VALUE_SIZE<span style="color:#555">))</span>
            <span style="color:#555">.</span><span style="color:#309">build</span><span style="color:#555">());</span>
    <span style="color:#069;font-weight:bold">if</span> <span style="color:#555">(!</span>res<span style="color:#555">.</span><span style="color:#309">equals</span><span style="color:#555">(</span>CreateResponse<span style="color:#555">.</span><span style="color:#309">getDefaultInstance</span><span style="color:#555">()))</span> <span style="color:#555">{</span>
      <span style="color:#069;font-weight:bold">throw</span> <span style="color:#069;font-weight:bold">new</span> RuntimeException<span style="color:#555">(</span><span style="color:#c30">&#34;Invalid response&#34;</span><span style="color:#555">);</span>
    <span style="color:#555">}</span>
  <span style="color:#555">}</span> <span style="color:#069;font-weight:bold">catch</span> <span style="color:#555">(</span>StatusRuntimeException e<span style="color:#555">)</span> <span style="color:#555">{</span>
    <span style="color:#069;font-weight:bold">if</span> <span style="color:#555">(</span>e<span style="color:#555">.</span><span style="color:#309">getStatus</span><span style="color:#555">().</span><span style="color:#309">getCode</span><span style="color:#555">()</span> <span style="color:#555">==</span> Code<span style="color:#555">.</span><span style="color:#309">ALREADY_EXISTS</span><span style="color:#555">)</span> <span style="color:#555">{</span>
      knownKeys<span style="color:#555">.</span><span style="color:#309">remove</span><span style="color:#555">(</span>key<span style="color:#555">);</span>
      logger<span style="color:#555">.</span><span style="color:#309">log</span><span style="color:#555">(</span>Level<span style="color:#555">.</span><span style="color:#309">INFO</span><span style="color:#555">,</span> <span style="color:#c30">&#34;Key already existed&#34;</span><span style="color:#555">,</span> e<span style="color:#555">);</span>
    <span style="color:#555">}</span> <span style="color:#069;font-weight:bold">else</span> <span style="color:#555">{</span>
      <span style="color:#069;font-weight:bold">throw</span> e<span style="color:#555">;</span>
    <span style="color:#555">}</span>
  <span style="color:#555">}</span>
<span style="color:#555">}</span>
</code></pre></div><p>A random key is created, along with a random value.  The request is sent to the server, and the
client waits for the response.  When the response is returned, the code checks that it is as
expected, and if not, throws an exception.  While the keys are chosen randomly, they need to be
unique, so we need to make sure that each key isn&rsquo;t already in use.  To address this, the code
keeps track of keys it has created, so as not to create the same key twice.  However, it&rsquo;s
possible that another client already created a particular key, so we log it and move on.
Otherwise, an exception is thrown.</p>
<p>We use the <strong>blocking</strong> gRPC API here, which issues a requests and waits for a response.
This is the simplest gRPC stub, but it blocks the thread while running.  This means that at most
<strong>one</strong> RPC can be in progress at a time from the client&rsquo;s point of view.</p>
<h3 id="server">Server</h3>
<p>On the server side, the request is received by the
<a href="https://github.com/carl-mastrangelo/kvstore/blob/f422b1b6e7c69f8c07f96ed4ddba64757242352c/src/main/java/io/grpc/examples/KvService.java#L34" target="_blank" rel="noopener">service handler<i class="fas fa-external-link-alt"></i></a>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#069;font-weight:bold">private</span> <span style="color:#069;font-weight:bold">final</span> Map<span style="color:#555">&lt;</span>ByteBuffer<span style="color:#555">,</span> ByteBuffer<span style="color:#555">&gt;</span> store <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> HashMap<span style="color:#555">&lt;&gt;();</span>

<span style="color:#99f">@Override</span>
<span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">synchronized</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">create</span><span style="color:#555">(</span>
    CreateRequest request<span style="color:#555">,</span> StreamObserver<span style="color:#555">&lt;</span>CreateResponse<span style="color:#555">&gt;</span> responseObserver<span style="color:#555">)</span> <span style="color:#555">{</span>
  ByteBuffer key <span style="color:#555">=</span> request<span style="color:#555">.</span><span style="color:#309">getKey</span><span style="color:#555">().</span><span style="color:#309">asReadOnlyByteBuffer</span><span style="color:#555">();</span>
  ByteBuffer value <span style="color:#555">=</span> request<span style="color:#555">.</span><span style="color:#309">getValue</span><span style="color:#555">().</span><span style="color:#309">asReadOnlyByteBuffer</span><span style="color:#555">();</span>
  simulateWork<span style="color:#555">(</span>WRITE_DELAY_MILLIS<span style="color:#555">);</span>
  <span style="color:#069;font-weight:bold">if</span> <span style="color:#555">(</span>store<span style="color:#555">.</span><span style="color:#309">putIfAbsent</span><span style="color:#555">(</span>key<span style="color:#555">,</span> value<span style="color:#555">)</span> <span style="color:#555">==</span> <span style="color:#069;font-weight:bold">null</span><span style="color:#555">)</span> <span style="color:#555">{</span>
    responseObserver<span style="color:#555">.</span><span style="color:#309">onNext</span><span style="color:#555">(</span>CreateResponse<span style="color:#555">.</span><span style="color:#309">getDefaultInstance</span><span style="color:#555">());</span>
    responseObserver<span style="color:#555">.</span><span style="color:#309">onCompleted</span><span style="color:#555">();</span>
    <span style="color:#069;font-weight:bold">return</span><span style="color:#555">;</span>
  <span style="color:#555">}</span>
  responseObserver<span style="color:#555">.</span><span style="color:#309">onError</span><span style="color:#555">(</span>Status<span style="color:#555">.</span><span style="color:#309">ALREADY_EXISTS</span><span style="color:#555">.</span><span style="color:#309">asRuntimeException</span><span style="color:#555">());</span>
<span style="color:#555">}</span>
</code></pre></div><p>The service extracts the key and value as <code>ByteBuffer</code>s from the request.  It acquires the lock
on the service itself to make sure concurrent requests don&rsquo;t corrupt the storage.  After
simulating the disk access of a write, it stores it in the <code>Map</code> of keys to values.</p>
<p>Unlike the client code, the service handler is <strong>non-blocking</strong>, meaning it doesn&rsquo;t return a
value like a function call would.  Instead, it invokes <code>onNext()</code> on the <code>responseObserver</code> to
send the response back to the client.  Note that this call is also non-blocking, meaning that
the message may not yet have been sent.  To indicate we are done with the message, <code>onCompleted()</code>
is called.</p>
<h3 id="performance">Performance</h3>
<p>Since the code is safe and correct, let&rsquo;s see how it performs.  For my measurement I&rsquo;m using my
Ubuntu system with a 12 core processor and 32 GB of memory.  Let&rsquo;s build and run the code:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./gradlew installDist
$ <span style="color:#366">time</span> ./build/install/kvstore/bin/kvstore
Feb 26, <span style="color:#f60">2018</span> 1:10:07 PM io.grpc.examples.KvRunner runClient
INFO: Starting
Feb 26, <span style="color:#f60">2018</span> 1:11:07 PM io.grpc.examples.KvRunner runClient
INFO: Did 16.55 RPCs/s

real	1m0.927s
user	0m10.688s
sys	0m1.456s
</code></pre></div><p>Yikes!  For such a powerful machine, it can only do about 16 RPCs per second.  It hardly used any
of our CPU, and we don&rsquo;t know how much memory it was using.  We need to figure out why it&rsquo;s so
slow.</p>
<h2 id="optimization">Optimization</h2>
<h3 id="analysis">Analysis</h3>
<p>Let&rsquo;s understand what the program is doing before we make any changes.  When optimizing, we need
to know where the code is spending its time in order to know what we can optimize.  At this early
stage, we don&rsquo;t need profiling tools yet, we can just reason about the program.</p>
<p>The client is started and serially issues RPCs for about a minute.  Each iteration, it <a href="https://github.com/carl-mastrangelo/kvstore/blob/f422b1b6e7c69f8c07f96ed4ddba64757242352c/src/main/java/io/grpc/examples/KvClient.java#L49" target="_blank" rel="noopener">randomly
decides<i class="fas fa-external-link-alt"></i></a>
what operation to do:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">doClientWork</span><span style="color:#555">(</span>AtomicBoolean done<span style="color:#555">)</span> <span style="color:#555">{</span>
  Random random <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Random<span style="color:#555">();</span>
  KeyValueServiceBlockingStub stub <span style="color:#555">=</span> KeyValueServiceGrpc<span style="color:#555">.</span><span style="color:#309">newBlockingStub</span><span style="color:#555">(</span>channel<span style="color:#555">);</span>

  <span style="color:#069;font-weight:bold">while</span> <span style="color:#555">(!</span>done<span style="color:#555">.</span><span style="color:#309">get</span><span style="color:#555">())</span> <span style="color:#555">{</span>
    <span style="color:#09f;font-style:italic">// Pick a random CRUD action to take.
</span><span style="color:#09f;font-style:italic"></span>    <span style="color:#078;font-weight:bold">int</span> command <span style="color:#555">=</span> random<span style="color:#555">.</span><span style="color:#309">nextInt</span><span style="color:#555">(</span>4<span style="color:#555">);</span>
    <span style="color:#069;font-weight:bold">if</span> <span style="color:#555">(</span>command <span style="color:#555">==</span> 0<span style="color:#555">)</span> <span style="color:#555">{</span>
      doCreate<span style="color:#555">(</span>stub<span style="color:#555">);</span>
      <span style="color:#069;font-weight:bold">continue</span><span style="color:#555">;</span>
    <span style="color:#555">}</span>
    <span style="color:#09f;font-style:italic">/* ... */</span>
    rpcCount<span style="color:#555">++;</span>
  <span style="color:#555">}</span>
<span style="color:#555">}</span>
</code></pre></div><p>This means that <strong>at most one RPC can be active at any time</strong>.  Each RPC has to wait for the
previous one to complete.  And how long does each RPC take to complete?  From reading the server
code, most of the operations are doing a write which takes about 50 milliseconds.  At top
efficiency, the most operations this code can do per second is about 20:</p>
<p>20 queries = 1000ms / (50 ms / query)</p>
<p>Our code can do about 16 queries in a second, so that seems about right.  We can spot check this
assumption by looking at the output of the <code>time</code> command used to run the code.  The server goes
to sleep when running queries in the
<a href="https://github.com/carl-mastrangelo/kvstore/blob/f422b1b6e7c69f8c07f96ed4ddba64757242352c/src/main/java/io/grpc/examples/KvService.java#L88" target="_blank" rel="noopener">simulateWork<i class="fas fa-external-link-alt"></i></a>
method. This implies that the program should be mostly idle while waiting for the RPCs to
complete.</p>
<p>We can confirm this is the case by looking at the <code>real</code> and <code>user</code> times of the command above.
They say that the amount of <em>wall clock</em> time was 1 minute, while the amount of <em>cpu</em> time
was 10 seconds.  My powerful, multicore CPU was only busy 16% of the time.  Thus, if we could
get the program to do more work during that time, it seems like we could get more RPCs complete.</p>
<h3 id="hypothesis">Hypothesis</h3>
<p>Now we can state clearly what we think is the problem, and propose a solution.  One way to speed
up programs is to make sure the CPU is not idling.  To do this, we issue work concurrently.</p>
<p>In gRPC Java, there are three types of stubs: blocking, non-blocking, and listenable future.  We
have already seen the blocking stub in the client, and the non-blocking stub in the server.  The
listenable future API is a compromise between the two, offering both blocking and non-blocking
like behavior.  As long as we don&rsquo;t block a thread waiting for work to complete, we can start
new RPCs without waiting for the old ones to complete.</p>
<h3 id="experiment">Experiment</h3>
<p>To test our hypothesis, let&rsquo;s modify the client code to use the listenable future API.  This
means that we need to think more about concurrency in our code.  For example, when keeping track
of known keys client-side, we need to safely read, modify, and write the keys.  We also need to
make sure that in case of an error, we stop making new RPCs (proper error handling will be covered
in a future post).  Lastly, we need to update the number of RPCs made concurrently, since the
update could happen in another thread.</p>
<p>Making all these changes increases the complexity of the code.  This is a trade off you will need
to consider when optimizing your code.  In general, code simplicity is at odds with optimization.
Java is not known for being terse.  That said, the code below is still readable, and program flow
is still roughly from top to bottom in the function.  Here is the
<a href="https://github.com/carl-mastrangelo/kvstore/blob/f0113912c01ac4ea48a80bb7a4736ddcb3f21e24/src/main/java/io/grpc/examples/KvClient.java#L92" target="_blank" rel="noopener">doCreate()<i class="fas fa-external-link-alt"></i></a>
method revised:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#069;font-weight:bold">private</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">doCreate</span><span style="color:#555">(</span>KeyValueServiceFutureStub stub<span style="color:#555">,</span> AtomicReference<span style="color:#555">&lt;</span>Throwable<span style="color:#555">&gt;</span> error<span style="color:#555">)</span> <span style="color:#555">{</span>
  ByteString key <span style="color:#555">=</span> createRandomKey<span style="color:#555">();</span>
  ListenableFuture<span style="color:#555">&lt;</span>CreateResponse<span style="color:#555">&gt;</span> res <span style="color:#555">=</span> stub<span style="color:#555">.</span><span style="color:#309">create</span><span style="color:#555">(</span>
      CreateRequest<span style="color:#555">.</span><span style="color:#309">newBuilder</span><span style="color:#555">()</span>
          <span style="color:#555">.</span><span style="color:#309">setKey</span><span style="color:#555">(</span>key<span style="color:#555">)</span>
          <span style="color:#555">.</span><span style="color:#309">setValue</span><span style="color:#555">(</span>randomBytes<span style="color:#555">(</span>MEAN_VALUE_SIZE<span style="color:#555">))</span>
          <span style="color:#555">.</span><span style="color:#309">build</span><span style="color:#555">());</span>
  res<span style="color:#555">.</span><span style="color:#309">addListener</span><span style="color:#555">(()</span> <span style="color:#555">-&gt;</span> rpcCount<span style="color:#555">.</span><span style="color:#309">incrementAndGet</span><span style="color:#555">(),</span> MoreExecutors<span style="color:#555">.</span><span style="color:#309">directExecutor</span><span style="color:#555">());</span>
  Futures<span style="color:#555">.</span><span style="color:#309">addCallback</span><span style="color:#555">(</span>res<span style="color:#555">,</span> <span style="color:#069;font-weight:bold">new</span> FutureCallback<span style="color:#555">&lt;</span>CreateResponse<span style="color:#555">&gt;()</span> <span style="color:#555">{</span>
    <span style="color:#99f">@Override</span>
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">onSuccess</span><span style="color:#555">(</span>CreateResponse result<span style="color:#555">)</span> <span style="color:#555">{</span>
      <span style="color:#069;font-weight:bold">if</span> <span style="color:#555">(!</span>result<span style="color:#555">.</span><span style="color:#309">equals</span><span style="color:#555">(</span>CreateResponse<span style="color:#555">.</span><span style="color:#309">getDefaultInstance</span><span style="color:#555">()))</span> <span style="color:#555">{</span>
        error<span style="color:#555">.</span><span style="color:#309">compareAndSet</span><span style="color:#555">(</span><span style="color:#069;font-weight:bold">null</span><span style="color:#555">,</span> <span style="color:#069;font-weight:bold">new</span> RuntimeException<span style="color:#555">(</span><span style="color:#c30">&#34;Invalid response&#34;</span><span style="color:#555">));</span>
      <span style="color:#555">}</span>
      <span style="color:#069;font-weight:bold">synchronized</span> <span style="color:#555">(</span>knownKeys<span style="color:#555">)</span> <span style="color:#555">{</span>
        knownKeys<span style="color:#555">.</span><span style="color:#309">add</span><span style="color:#555">(</span>key<span style="color:#555">);</span>
      <span style="color:#555">}</span>
    <span style="color:#555">}</span>

    <span style="color:#99f">@Override</span>
    <span style="color:#069;font-weight:bold">public</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">onFailure</span><span style="color:#555">(</span>Throwable t<span style="color:#555">)</span> <span style="color:#555">{</span>
      Status status <span style="color:#555">=</span> Status<span style="color:#555">.</span><span style="color:#309">fromThrowable</span><span style="color:#555">(</span>t<span style="color:#555">);</span>
      <span style="color:#069;font-weight:bold">if</span> <span style="color:#555">(</span>status<span style="color:#555">.</span><span style="color:#309">getCode</span><span style="color:#555">()</span> <span style="color:#555">==</span> Code<span style="color:#555">.</span><span style="color:#309">ALREADY_EXISTS</span><span style="color:#555">)</span> <span style="color:#555">{</span>
        <span style="color:#069;font-weight:bold">synchronized</span> <span style="color:#555">(</span>knownKeys<span style="color:#555">)</span> <span style="color:#555">{</span>
          knownKeys<span style="color:#555">.</span><span style="color:#309">remove</span><span style="color:#555">(</span>key<span style="color:#555">);</span>
        <span style="color:#555">}</span>
        logger<span style="color:#555">.</span><span style="color:#309">log</span><span style="color:#555">(</span>Level<span style="color:#555">.</span><span style="color:#309">INFO</span><span style="color:#555">,</span> <span style="color:#c30">&#34;Key already existed&#34;</span><span style="color:#555">,</span> t<span style="color:#555">);</span>
      <span style="color:#555">}</span> <span style="color:#069;font-weight:bold">else</span> <span style="color:#555">{</span>
        error<span style="color:#555">.</span><span style="color:#309">compareAndSet</span><span style="color:#555">(</span><span style="color:#069;font-weight:bold">null</span><span style="color:#555">,</span> t<span style="color:#555">);</span>
      <span style="color:#555">}</span>
    <span style="color:#555">}</span>
  <span style="color:#555">});</span>
<span style="color:#555">}</span>
</code></pre></div><p>The stub has been modified to be a <code>KeyValueServiceFutureStub</code>, which produces a <code>Future</code> when
called instead of the response itself.  gRPC Java uses an extension of this called <code>ListenableFuture</code>,
which allows adding a callback when the future completes.  For the sake of this program, we are
not as concerned with getting the response.  Instead we care more if the RPC succeeded or not.
With that in mind, the code mainly checks for errors rather than processing the response.</p>
<p>The first change made is how the number of RPCs is recorded.  Instead of incrementing the counter
outside of the main loop, we increment it when the RPC completes.</p>
<p>Next, we create a new object
for each RPC which handles both the success and failure cases.  Because <code>doCreate()</code> will already
be completed by the time RPC callback is invoked, we need a way to propagate errors other than
by throwing.  Instead, we try to update an reference atomically.  The main loop will occasionally
check if an error has occurred and stop if there is a problem.</p>
<p>Lastly, the code is careful to only add a key to <code>knownKeys</code> when the RPC is actually complete,
and only remove it when known to have failed.  We synchronize on the variable to make sure two
threads don&rsquo;t conflict.  Note: although the access to <code>knownKeys</code> is threadsafe, there are still
<a href="https://en.wikipedia.org/wiki/Race_condition" target="_blank" rel="noopener">race conditions<i class="fas fa-external-link-alt"></i></a>.  It is possible that one thread
could read from <code>knownKeys</code>, a second thread delete from <code>knownKeys</code>, and then the first thread
issue an RPC using the first key.  Synchronizing on the keys only ensures that it is consistent,
not that it is correct.  Fixing this properly is outside of the scope of this post, so instead we
just log the event and move on.  You will see a few such log statements if you run this program.</p>
<h3 id="running-the-code">Running the Code</h3>
<p>If you start up this program and run it, you&rsquo;ll notice that it doesn&rsquo;t work:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">WARNING: An exception was thrown by io.grpc.netty.NettyClientStream<span style="color:#033">$Sink$1</span>.operationComplete<span style="color:#555">()</span>
java.lang.OutOfMemoryError: unable to create new native thread
	at java.lang.Thread.start0<span style="color:#555">(</span>Native Method<span style="color:#555">)</span>
	at java.lang.Thread.start<span style="color:#555">(</span>Thread.java:714<span style="color:#555">)</span>
	...
</code></pre></div><p>What?!  Why would I show you code that fails?  The reason is that in real life making a change often
doesn&rsquo;t work on the first try.  In this case, the program ran out of memory.  Odd things begin to
happen when a program runs out of memory.  Often, the root cause is hard to find, and red herrings
abound.  A confusing error message says &ldquo;unable to create new native thread&rdquo;
even though we didn&rsquo;t create any new threads in our code.  Experience is very helpful in fixing
these problems rather than debugging.  Since I have debugged many OOMs, I happen to know Java tells
us about the straw that broke the camel&rsquo;s back.  Our program started using way more memory, but the
final allocation that failed happened, by chance, to be in thread creation.</p>
<p>So what happened?  <em>There was no pushback to starting new RPCs.</em>  In the blocking version, a new
RPC couldn&rsquo;t start until the last one completed.  While slow, it also prevented us from creating
tons of RPCs that we didn&rsquo;t have memory for.  We need to account for this in the listenable
future version.</p>
<p>To solve this, we can apply a self-imposed limit on the number of active RPCs.  Before starting a
new RPC, we will try to acquire a permit.  If we get one, the RPC can start.  If not, we will wait
until one is available.  When an RPC completes (either in success or failure), we return the
permit.  To <a href="https://github.com/carl-mastrangelo/kvstore/blob/02-future-client/src/main/java/io/grpc/examples/KvClient.java#L94" target="_blank" rel="noopener">accomplish<i class="fas fa-external-link-alt"></i></a>
this, we will using a <code>Semaphore</code>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#069;font-weight:bold">private</span> <span style="color:#069;font-weight:bold">final</span> Semaphore limiter <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Semaphore<span style="color:#555">(</span>100<span style="color:#555">);</span>

<span style="color:#069;font-weight:bold">private</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">doCreate</span><span style="color:#555">(</span>KeyValueServiceFutureStub stub<span style="color:#555">,</span> AtomicReference<span style="color:#555">&lt;</span>Throwable<span style="color:#555">&gt;</span> error<span style="color:#555">)</span>
    <span style="color:#069;font-weight:bold">throws</span> InterruptedException <span style="color:#555">{</span>
  limiter<span style="color:#555">.</span><span style="color:#309">acquire</span><span style="color:#555">();</span>
  ByteString key <span style="color:#555">=</span> createRandomKey<span style="color:#555">();</span>
  ListenableFuture<span style="color:#555">&lt;</span>CreateResponse<span style="color:#555">&gt;</span> res <span style="color:#555">=</span> stub<span style="color:#555">.</span><span style="color:#309">create</span><span style="color:#555">(</span>
      CreateRequest<span style="color:#555">.</span><span style="color:#309">newBuilder</span><span style="color:#555">()</span>
          <span style="color:#555">.</span><span style="color:#309">setKey</span><span style="color:#555">(</span>key<span style="color:#555">)</span>
          <span style="color:#555">.</span><span style="color:#309">setValue</span><span style="color:#555">(</span>randomBytes<span style="color:#555">(</span>MEAN_VALUE_SIZE<span style="color:#555">))</span>
          <span style="color:#555">.</span><span style="color:#309">build</span><span style="color:#555">());</span>
  res<span style="color:#555">.</span><span style="color:#309">addListener</span><span style="color:#555">(()</span> <span style="color:#555">-&gt;</span>  <span style="color:#555">{</span>
    rpcCount<span style="color:#555">.</span><span style="color:#309">incrementAndGet</span><span style="color:#555">();</span>
    limiter<span style="color:#555">.</span><span style="color:#309">release</span><span style="color:#555">();</span>
  <span style="color:#555">},</span> MoreExecutors<span style="color:#555">.</span><span style="color:#309">directExecutor</span><span style="color:#555">());</span>
  <span style="color:#09f;font-style:italic">/* ... */</span>
<span style="color:#555">}</span>
</code></pre></div><p>Now the code runs successfully, and doesn&rsquo;t run out of memory.</p>
<h3 id="results">Results</h3>
<p>Building and running the code again looks a lot better:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./gradlew installDist
$ <span style="color:#366">time</span> ./build/install/kvstore/bin/kvstore
Feb 26, <span style="color:#f60">2018</span> 2:40:47 PM io.grpc.examples.KvRunner runClient
INFO: Starting
Feb 26, <span style="color:#f60">2018</span> 2:41:47 PM io.grpc.examples.KvRunner runClient
INFO: Did 24.283 RPCs/s

real	1m0.923s
user	0m12.772s
sys	0m1.572s
</code></pre></div><p>Our code does <strong>46%</strong> more RPCs per second than previously.  We can also see that we used about 20%
more CPU than previously.  As we can see our hypothesis turned out to be correct and the fix
worked.  All this happened without making any changes to the server.  Also, we were able to
measure without using any special profilers or tracers.</p>
<p>Do the numbers make sense?  We expect to issue mutation (create, update, and delete) RPCs each
about with 1/4 probability.  Reads are also issue 1/4 of the time, but don&rsquo;t take as long.  The
mean RPC time should be about the weighted average RPC time:</p>
<pre><code class="language-nocode" data-lang="nocode">  .25 * 50ms (create)
  .25 * 10ms (retrieve)
  .25 * 50ms (update)
 +.25 * 50ms (delete)
------------
        40ms
</code></pre><p>At 40ms on average per RPC, we would expect the number of RPCs per second to be:</p>
<p>25 queries = 1000ms / (40 ms / query)</p>
<p>That&rsquo;s approximately what we see with the new code.  The server is still serially handling
requests, so it seems like we have more work to do in the future.  But for now, our optimizations
seem to have worked.</p>
<h2 id="conclusion">Conclusion</h2>
<p>There are a lot of opportunities to optimize your gRPC code.  To take advantage of these, you
need to understand what your code is doing, and what your code is supposed to do.  This post shows
the very basics of how to approach and think about optimization.  Always make sure to measure
before and after your changes, and use these measurements to guide your optimizations.</p>
<p>In <a href="/blog/optimizing-grpc-part-2/">Part 2</a>, we will continue optimizing the server part of the code.</p>
	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/blog/deadlines/" class="btn btn-primary "><span class="mr-1">←</span> Previous</a>
  </li>
    <a href="/blog/optimizing-grpc-part-2/" class="btn btn-primary ">Next <span class="ml-1">→</span></a>
  </li>
</ul>

	<div class="c-global-meta-links">
		
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
    
    
      
    
    
    
    
    
    
    

    <a href="https://github.com/grpc/grpc.io/edit/main/content/en/blog/optimizing-grpc-part-1.md" target="_blank"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
    <a href="https://github.com/grpc/grpc.io/new/main/content/en/blog/optimizing-grpc-part-1.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" target="_blank"><i class="fa fa-edit fa-fw"></i> Create child page</a>
    <a href="https://github.com/grpc/grpc.io/issues/new?title=So%20You%20Want%20to%20Optimize%20gRPC%20-%20Part%201" target="_blank"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
    
      
      <a href="https://github.com/grpc/grpc.io/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
    

  
  
  </div>


	</div>
</div>

          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://twitter.com/grpcio">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Google Groups" aria-label="Google Groups">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://groups.google.com/g/grpc-io">
      <i class="fab fa-google"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Gitter" aria-label="Gitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://gitter.im/grpc/grpc">
      <i class="fab fa-gitter"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/grpc">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 gRPC Authors
          
        </small>
        
        
      </div>
    </div>
    <div class="row text-center text-white small">
      <div class="col-12 text-center py-2 order-sm-2">
        <a href="https://www.linuxfoundation.org/terms" target="_blank" rel="noopener">Terms</a> |
        <a href="https://www.linuxfoundation.org/privacy" target="_blank" rel="noopener">Privacy</a> |
        <a href="https://www.linuxfoundation.org/trademark-usage" target="_blank" rel="noopener">Trademarks</a> |
        <a href="https://github.com/grpc/grpc.io/blob/main/LICENSE" target="_blank" rel="noopener">License</a> |
        <a href="/about/">About</a>
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>











<script src="/js/main.min.d862e8117d34e02dff1772aeeb47caf7ed851d0f8a3a5345f7a32ccfb2f6b87f.js" integrity="sha256-2GLoEX004C3/F3Ku60fK9&#43;2FHQ&#43;KOlNF96Msz7L2uH8=" crossorigin="anonymous"></script>




  </body>
</html>